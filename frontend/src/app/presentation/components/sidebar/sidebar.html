<aside class="h-screen w-72 p-4 flex flex-col border-r border-blue-800/50 sticky top-0">
    <div class="flex flex-col h-full gap-3">
        <div class="flex items-center justify-between">
            <button [routerLink]="[siteRoutesConfig.base.url]"
                class="flex items-center gap-2 rounded-lg bg-gradient-to-l from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 transition-all cursor-pointer py-2 px-3 text-white font-semibold">
                <mat-icon>home</mat-icon>
                Agentes
            </button>
            <button class="flex items-center gap-1 text-xs opacity-70 hover:opacity-100" (click)="tryLoad()" [disabled]="!agentId || isLoading">
                <mat-icon fontIcon="refresh"></mat-icon>Refrescar
            </button>
        </div>

        <button class="flex items-center justify-center gap-2 rounded-lg bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-500 hover:to-cyan-400 transition-all cursor-pointer py-2 px-4 text-white font-semibold" (click)="newChat()" [disabled]="!agentId">
            <mat-icon>edit_square</mat-icon> Nuevo chat
        </button>

        <div class="flex-1 overflow-y-auto">
            <div class="text-sm opacity-70 px-2 mb-2">Historial</div>
            <ng-container *ngIf="agentId; else emptyState">
                <div *ngIf="isLoading" class="px-2 py-2 text-xs text-info flex items-center gap-2">
                    <span class="loading loading-dots loading-xs"></span>
                    Cargando sesiones…
                </div>
                <div *ngIf="!isLoading && sessions.length === 0" class="px-2 py-2 text-xs opacity-60">Sin sesiones todavía</div>
                <ul class="space-y-2">
                    <li *ngFor="let s of sessions" class="group border border-white/10 rounded-md hover:bg-white/5">
                        <div class="flex items-center justify-between px-2 py-2 gap-2">
                            <button class="text-left flex-1 truncate" (click)="openSession(s)">
                                <div class="text-sm font-medium truncate">{{ s.title || ('Sesión ' + s.session_id.slice(0,6)) }}</div>
                                <div class="text-xs opacity-60 truncate">{{ s.session_id }}</div>
                            </button>
                            <div class="flex items-center gap-1">
                                <button class="btn btn-ghost btn-xs" (click)="togglePreview(s)" title="Ver mensajes">
                                    <mat-icon fontIcon="expand_more"></mat-icon>
                                </button>
                                <button class="btn btn-ghost btn-xs text-error" (click)="deleteSession(s, $event)" title="Eliminar">
                                    <mat-icon fontIcon="delete"></mat-icon>
                                </button>
                            </div>
                        </div>
                        <div *ngIf="expanded[s.session_id]" class="px-2 pb-2 space-y-1 max-h-48 overflow-y-auto">
                            <div *ngIf="!previews[s.session_id]" class="text-xs opacity-60">Cargando…</div>
                              <div *ngFor="let m of previews[s.session_id]" class="text-xs opacity-80 truncate">• {{ m.who }}: {{ m.text }}</div>
                        </div>
                    </li>
                </ul>
            </ng-container>
            <ng-template #emptyState>
                <div class="px-2 py-1 text-xs opacity-60">Abre un agente para ver y cargar sesiones</div>
            </ng-template>
        </div>

        <div class="border-t border-blue-800/50 pt-2">
            <app-chat-button text="Clear conversations"
                icon="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M1 7h22M10 3h4a1 1 0 011 1v1H9V4a1 1 0 011-1z">
            </app-chat-button>
            <app-chat-button text="Light mode"
                icon="M12 3v1m0 16v1m8.66-8.66h-1M4.34 12H3m15.36-6.36l-.7.7M6.34 17.66l-.7.7m12.02 0l-.7-.7M6.34 6.34l-.7-.7M12 5a7 7 0 100 14 7 7 0 000-14z">
            </app-chat-button>
            <app-chat-button text="My account"
                icon="M5.121 17.804A9.004 9.004 0 0112 15c2.216 0 4.244.806 5.879 2.137M15 11a3 3 0 11-6 0 3 3 0 016 0z">
            </app-chat-button>
        </div>
    </div>
</aside>