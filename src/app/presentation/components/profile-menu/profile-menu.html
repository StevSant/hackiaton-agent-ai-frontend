<div class="text-xs relative" (click)="$event.stopPropagation()" (keydown.escape)="profileMenuOpen.set(false)">
  <div class="flex items-center justify-between gap-2" *ngIf="!showBackToChat; else adminBackBlock">
    <button class="flex items-center gap-2 group" (click)="toggleProfileMenu($event)" [title]="'COMMON.ACCOUNT' | translate">
      <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-semibold group-hover:scale-105 transition">
        <ng-container *ngIf="profileEmail(); else footerUserIcon">
          {{ profileEmail()!.charAt(0).toUpperCase() }}
        </ng-container>
        <ng-template #footerUserIcon>
          <mat-icon fontIcon="person" class="!text-base"></mat-icon>
        </ng-template>
      </div>
      <div class="leading-tight text-left">
        <div class="font-medium text-base-content/90 truncate max-w-[9rem]">{{ profileEmail() || ('COMMON.GUEST' | translate) }}</div>
        <div class="opacity-70 flex items-center gap-2" *ngIf="isAuthenticated()">
          <span class="badge badge-outline" [ngClass]="{'badge-primary': profileRole() === 'admin'}">
            {{ profileRole() === 'admin' ? ('COMMON.ADMIN' | translate) : ('COMMON.USER' | translate) }}
          </span>
        </div>
      </div>
    </button>
  </div>

  <ng-template #adminBackBlock>
    <div class="space-y-2">
      <a routerLink="/chat" class="btn btn-primary w-full"><mat-icon fontIcon="home"></mat-icon><span class="ml-2">{{ 'COMMON.BACK_TO_CHAT' | translate }}</span></a>
      <div class="text-xs">
  <button class="flex items-center gap-2 w-full text-left px-2 py-1 rounded-lg hover:bg-[hsl(var(--card)_/_0.5)]" (click)="toggleProfileMenu($event)" [title]="'COMMON.ACCOUNT' | translate">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-semibold">
            {{ (profileEmail() || '?')!.charAt(0).toUpperCase() }}
          </div>
          <div class="leading-tight">
            <div class="font-medium text-base-content/90 truncate max-w-[9rem]">{{ profileEmail() || ('COMMON.GUEST' | translate) }}</div>
            <div class="opacity-70" *ngIf="isAuthenticated()">
              <span class="badge badge-outline" [ngClass]="{'badge-primary': profileRole() === 'admin'}">
                {{ profileRole() === 'admin' ? ('COMMON.ADMIN' | translate) : ('COMMON.USER' | translate) }}
              </span>
            </div>
          </div>
        </button>
      </div>
    </div>
  </ng-template>

  <div *ngIf="profileMenuOpen()"
       class="absolute right-0 bottom-12 w-56 rounded-xl profile-menu-surface p-3 shadow-lg animate-in fade-in zoom-in text-base-content z-50"
       style="animation-duration:120ms;">
    <div class="profile-menu-header mb-2">{{ 'COMMON.ACCOUNT' | translate }}</div>
    <div *ngIf="profileLoading()" class="text-sm flex items-center gap-2">
      <span class="loading loading-dots loading-xs"></span> {{ 'COMMON.LOADING' | translate }}
    </div>
  <button *ngIf="!isAuthenticated()" (click)="toggleProfileMenu(); navigateToLogin()"
            class="w-full text-left text-sm px-3 py-2 rounded-lg hover:bg-[hsl(var(--card)_/_0.5)] bg-[hsl(var(--card)_/_0.2)]">{{ 'COMMON.LOGIN' | translate }}</button>
  <button *ngIf="isAuthenticated()" (click)="logout($event)"
      class="w-full text-left text-sm px-3 py-2 rounded-lg hover:bg-[hsl(var(--card)_/_0.5)] bg-[hsl(var(--card)_/_0.2)] flex items-center gap-2 text-error">
      <mat-icon fontIcon="logout" class="!text-base"></mat-icon> {{ 'COMMON.LOGOUT' | translate }}
    </button>
    <div class="mt-2 pt-2 profile-menu-divider profile-menu-section p-2">
      <div class="text-xs uppercase tracking-wide opacity-60 mb-1">{{ 'COMMON.LANGUAGE' | translate }}</div>
      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-xs" (click)="switchLang('es')">{{ 'COMMON.SPANISH' | translate }}</button>
        <button class="btn btn-xs" (click)="switchLang('en')">{{ 'COMMON.ENGLISH' | translate }}</button>
      </div>
    </div>
    <div class="mt-2 pt-2 profile-menu-divider profile-menu-section p-2">
      <div class="text-xs uppercase tracking-wide opacity-60 mb-1">{{ 'COMMON.THEME' | translate }}</div>
      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-xs" (click)="setTheme('light')">{{ 'COMMON.THEME_LIGHT' | translate }}</button>
        <button class="btn btn-xs" (click)="setTheme('dark')">{{ 'COMMON.THEME_DARK' | translate }}</button>
        <button class="btn btn-xs" (click)="setTheme('system')">{{ 'COMMON.THEME_SYSTEM' | translate }}</button>
      </div>
    </div>
    <div class="mt-2 pt-2 profile-menu-divider profile-menu-section p-2">
      <div class="text-xs uppercase tracking-wide opacity-60 mb-1">Background</div>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="btn btn-xs" (click)="setBg('minimal')">Minimal</button>
        <button class="btn btn-xs" (click)="setBg('aurora')">Aurora</button>
        <button class="btn btn-xs" (click)="setBg('bokeh')">Bokeh</button>
      </div>
      <div class="text-xs uppercase tracking-wide opacity-60 mb-1">Palette</div>
      <div class="flex gap-2 flex-wrap mb-2">
        <button class="btn btn-xs" (click)="setPalette('default')">Default</button>
        <button class="btn btn-xs" (click)="setPalette('vaporwave')">Vaporwave</button>
        <button class="btn btn-xs" (click)="setPalette('cyber')">Cyber</button>
      </div>
      <div class="flex items-center justify-between gap-2 text-sm">
        <button class="btn btn-xs" (click)="toggleNeonEdges()">Neon edges</button>
        <button class="btn btn-xs" (click)="toggleParallax()">Parallax</button>
      </div>
    </div>
  </div>

  <!-- Slot for optional extra actions (e.g., admin button) -->
  <ng-content></ng-content>
</div>
