<div
  class="profile-menu-container"
  (click)="$event.stopPropagation()"
  (keydown.escape)="profileMenuOpen.set(false)"
>
  @if (!showBackToChat) {
    <div class="profile-trigger-wrapper">
      <button
        class="profile-trigger"
        (click)="toggleProfileMenu($event)"
        [attr.aria-expanded]="profileMenuOpen()"
        [attr.aria-label]="'COMMON.ACCOUNT' | translate"
        [title]="'COMMON.ACCOUNT' | translate"
      >
        <div class="profile-avatar">
          @if (profileEmail()) {
            <span class="avatar-initial">{{
              profileEmail()!.charAt(0).toUpperCase()
            }}</span>
          } @else {
            <mat-icon fontIcon="person" class="avatar-icon"></mat-icon>
          }
          @if (isAuthenticated()) {
            <div class="avatar-status-indicator"></div>
          }
        </div>
        <div class="profile-info">
          <div class="profile-name">
            {{ profileEmail() || ("COMMON.GUEST" | translate) }}
          </div>
          @if (isAuthenticated()) {
            <div class="profile-role">
              <span
                class="role-badge"
                [ngClass]="{ 'role-admin': profileRole() === 'admin' }"
              >
                {{
                  profileRole() === "admin"
                    ? ("COMMON.ADMIN" | translate)
                    : ("COMMON.USER" | translate)
                }}
              </span>
            </div>
          }
        </div>
        <mat-icon
          fontIcon="expand_more"
          class="expand-icon"
          [class.expanded]="profileMenuOpen()"
        ></mat-icon>
      </button>
    </div>
  } @else {
    <div class="back-navigation">
      @if (showBackHome) {
        <a routerLink="/home" class="nav-button primary">
          <mat-icon fontIcon="home"></mat-icon>
          <span>{{ "NOT_FOUND.BACK_HOME" | translate }}</span>
        </a>
      }
      <a routerLink="/chat" class="nav-button primary">
        <mat-icon fontIcon="chat"></mat-icon>
        <span>{{ "COMMON.BACK_TO_CHAT" | translate }}</span>
      </a>
      <button
        class="profile-trigger compact"
        (click)="toggleProfileMenu($event)"
        [attr.aria-expanded]="profileMenuOpen()"
        [title]="'COMMON.ACCOUNT' | translate"
      >
        <div class="profile-avatar">
          <span class="avatar-initial">{{
            (profileEmail() || "?")!.charAt(0).toUpperCase()
          }}</span>
        </div>
        <div class="profile-info">
          <div class="profile-name">
            {{ profileEmail() || ("COMMON.GUEST" | translate) }}
          </div>
          @if (isAuthenticated()) {
            <div class="profile-role">
              <span
                class="role-badge"
                [ngClass]="{ 'role-admin': profileRole() === 'admin' }"
              >
                {{
                  profileRole() === "admin"
                    ? ("COMMON.ADMIN" | translate)
                    : ("COMMON.USER" | translate)
                }}
              </span>
            </div>
          }
        </div>
      </button>
    </div>
  }

  @if (profileMenuOpen()) {
    <div class="profile-dropdown">
      <div class="dropdown-header">
        <mat-icon fontIcon="account_circle" class="header-icon"></mat-icon>
        <span>{{ "COMMON.ACCOUNT" | translate }}</span>
      </div>

      @if (profileLoading()) {
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <span>{{ "COMMON.LOADING" | translate }}</span>
        </div>
      }

      @if (!isAuthenticated()) {
        <button
          class="menu-button primary"
          (click)="toggleProfileMenu(); navigateToLogin()"
        >
          <mat-icon fontIcon="login"></mat-icon>
          <span>{{ "COMMON.LOGIN" | translate }}</span>
        </button>
      }

      @if (isAuthenticated()) {
        <button class="menu-button danger" (click)="logout($event)">
          <mat-icon fontIcon="logout"></mat-icon>
          <span>{{ "COMMON.LOGOUT" | translate }}</span>
        </button>
      }

      <div class="menu-section">
        <div class="section-header">
          <mat-icon fontIcon="language" class="section-icon"></mat-icon>
          <span>{{ "COMMON.LANGUAGE" | translate }}</span>
        </div>
        <div class="button-group">
          <button
            class="toggle-button"
            [class.active]="lang.current() === 'es'"
            (click)="switchLang('es')"
          >
            <span class="flag">ðŸ‡ªðŸ‡¸</span>
            <span>{{ "COMMON.SPANISH" | translate }}</span>
          </button>
          <button
            class="toggle-button"
            [class.active]="lang.current() === 'en'"
            (click)="switchLang('en')"
          >
            <span class="flag">ðŸ‡ºðŸ‡¸</span>
            <span>{{ "COMMON.ENGLISH" | translate }}</span>
          </button>
        </div>
      </div>

      <div class="menu-section">
        <div class="section-header">
          <mat-icon fontIcon="palette" class="section-icon"></mat-icon>
          <span>{{ "COMMON.THEME" | translate }}</span>
        </div>
        <div class="button-group">
          <button
            class="toggle-button"
            [class.active]="theme.theme() === 'light'"
            (click)="setTheme('light')"
          >
            <mat-icon fontIcon="light_mode"></mat-icon>
            <span>{{ "COMMON.THEME_LIGHT" | translate }}</span>
          </button>
          <button
            class="toggle-button"
            [class.active]="theme.theme() === 'dark'"
            (click)="setTheme('dark')"
          >
            <mat-icon fontIcon="dark_mode"></mat-icon>
            <span>{{ "COMMON.THEME_DARK" | translate }}</span>
          </button>
          <button
            class="toggle-button"
            [class.active]="theme.theme() === 'system'"
            (click)="setTheme('system')"
          >
            <mat-icon fontIcon="settings_system_daydream"></mat-icon>
            <span>{{ "COMMON.THEME_SYSTEM" | translate }}</span>
          </button>
        </div>
      </div>

      <div class="menu-section">
        <div class="section-header">
          <mat-icon fontIcon="wallpaper" class="section-icon"></mat-icon>
          <span>Background</span>
        </div>
        <div class="button-group">
          <button
            class="toggle-button"
            [class.active]="bg.bg() === 'minimal'"
            (click)="setBg('minimal')"
          >
            <span>Minimal</span>
          </button>
          <button
            class="toggle-button"
            [class.active]="bg.bg() === 'aurora'"
            (click)="setBg('aurora')"
          >
            <span>Aurora</span>
          </button>
          <button
            class="toggle-button"
            [class.active]="bg.bg() === 'bokeh'"
            (click)="setBg('bokeh')"
          >
            <span>Bokeh</span>
          </button>
        </div>

        <div class="section-header">
          <mat-icon fontIcon="color_lens" class="section-icon"></mat-icon>
          <span>Palette</span>
        </div>
        <div class="button-group">
          <button
            class="toggle-button"
            [class.active]="bg.palette() === 'default'"
            (click)="setPalette('default')"
          >
            <span>Default</span>
          </button>
          <button
            class="toggle-button"
            [class.active]="bg.palette() === 'vaporwave'"
            (click)="setPalette('vaporwave')"
          >
            <span>Vaporwave</span>
          </button>
          <button
            class="toggle-button"
            [class.active]="bg.palette() === 'cyber'"
            (click)="setPalette('cyber')"
          >
            <span>Cyber</span>
          </button>
        </div>

        <div class="toggle-group">
          <button
            class="toggle-switch"
            [class.active]="bg.neon()"
            (click)="toggleNeonEdges()"
          >
            <mat-icon fontIcon="highlight" class="toggle-icon"></mat-icon>
            <span>Neon edges</span>
            <div class="switch-track">
              <div class="switch-thumb"></div>
            </div>
          </button>
          <button
            class="toggle-switch"
            [class.active]="bg.parallax()"
            (click)="toggleParallax()"
          >
            <mat-icon fontIcon="view_in_ar" class="toggle-icon"></mat-icon>
            <span>Parallax</span>
            <div class="switch-track">
              <div class="switch-thumb"></div>
            </div>
          </button>
        </div>
      </div>
    </div>
  }
</div>