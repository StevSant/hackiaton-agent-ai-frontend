<div
  class="text-xs relative"
  (click)="$event.stopPropagation()"
  (keydown.escape)="profileMenuOpen.set(false)"
>
  @if (!showBackToChat) {
    <div class="flex items-center justify-between gap-2">
      <button
        class="flex items-center gap-3 group px-4 py-3 text-base"
        (click)="toggleProfileMenu($event)"
        [title]="'COMMON.ACCOUNT' | translate"
      >
        <div
          class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold text-lg group-hover:scale-105 transition"
        >
          @if (profileEmail()) {
            {{ profileEmail()!.charAt(0).toUpperCase() }}
          } @else {
            <mat-icon fontIcon="person" class="!text-xl"></mat-icon>
          }
        </div>
        <div class="leading-tight text-left">
          <div
            class="font-medium text-base-content/90 truncate max-w-[12rem] text-lg"
          >
            {{ profileEmail() || ("COMMON.GUEST" | translate) }}
          </div>
          @if (isAuthenticated()) {
            <div class="opacity-70 flex items-center gap-2">
              <span
                class="badge badge-outline text-sm px-3 py-1"
                [ngClass]="{ 'badge-primary': profileRole() === 'admin' }"
              >
                {{
                  profileRole() === "admin"
                    ? ("COMMON.ADMIN" | translate)
                    : ("COMMON.USER" | translate)
                }}
              </span>
            </div>
          }
        </div>
      </button>
    </div>
  } @else {
    <div class="space-y-2">
      @if (showBackHome) {
        <a routerLink="/home" class="btn btn-primary w-full">
          <mat-icon fontIcon="home"></mat-icon>
          <span class="ml-2">{{ "NOT_FOUND.BACK_HOME" | translate }}</span>
        </a>
      }
      <a routerLink="/chat" class="btn btn-primary w-full">
        <mat-icon fontIcon="chat"></mat-icon>
        <span class="ml-2">{{ "COMMON.BACK_TO_CHAT" | translate }}</span>
      </a>
      <div class="text-xs">
        <button
          class="flex items-center gap-3 w-full text-left px-4 py-3 rounded-lg hover:bg-[hsl(var(--card)_/_0.5)] text-base"
          (click)="toggleProfileMenu($event)"
          [title]="'COMMON.ACCOUNT' | translate"
        >
          <div
            class="w-12 h-12 rounded-full bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center text-white font-bold text-lg"
          >
            {{ (profileEmail() || "?")!.charAt(0).toUpperCase() }}
          </div>
          <div class="leading-tight">
            <div
              class="font-medium text-base-content/90 truncate max-w-[12rem] text-lg"
            >
              {{ profileEmail() || ("COMMON.GUEST" | translate) }}
            </div>
            @if (isAuthenticated()) {
              <div class="opacity-70">
                <span
                  class="badge badge-outline text-sm px-3 py-1"
                  [ngClass]="{ 'badge-primary': profileRole() === 'admin' }"
                >
                  {{
                    profileRole() === "admin"
                      ? ("COMMON.ADMIN" | translate)
                      : ("COMMON.USER" | translate)
                  }}
                </span>
              </div>
            }
          </div>
        </button>
      </div>
    </div>
  }

  @if (profileMenuOpen()) {
    <div
      class="absolute right-0 bottom-12 w-56 rounded-xl profile-menu-surface p-3 shadow-lg animate-in fade-in zoom-in text-base-content z-50"
      style="animation-duration: 120ms"
    >
      <div class="profile-menu-header mb-2">
        {{ "COMMON.ACCOUNT" | translate }}
      </div>
      @if (profileLoading()) {
        <div class="text-sm flex items-center gap-2">
          <span class="loading loading-dots loading-xs"></span>
          {{ "COMMON.LOADING" | translate }}
        </div>
      }
      @if (!isAuthenticated()) {
        <button
          (click)="toggleProfileMenu(); navigateToLogin()"
          class="w-full text-left text-sm px-3 py-2 rounded-lg hover:bg-[hsl(var(--card)_/_0.5)] bg-[hsl(var(--card)_/_0.2)]"
        >
          {{ "COMMON.LOGIN" | translate }}
        </button>
      }
      @if (isAuthenticated()) {
        <button
          (click)="logout($event)"
          class="w-full text-left text-sm px-3 py-2 rounded-lg hover:bg-[hsl(var(--card)_/_0.5)] bg-[hsl(var(--card)_/_0.2)] flex items-center gap-2 text-error"
        >
          <mat-icon fontIcon="logout" class="!text-base"></mat-icon>
          {{ "COMMON.LOGOUT" | translate }}
        </button>
      }
      <div class="mt-2 pt-2 profile-menu-divider profile-menu-section p-2">
        <div class="text-xs uppercase tracking-wide opacity-60 mb-1">
          {{ "COMMON.LANGUAGE" | translate }}
        </div>
        <div class="flex gap-2 flex-wrap">
          <button class="btn btn-xs" (click)="switchLang('es')">
            {{ "COMMON.SPANISH" | translate }}
          </button>
          <button class="btn btn-xs" (click)="switchLang('en')">
            {{ "COMMON.ENGLISH" | translate }}
          </button>
        </div>
      </div>
      <div class="mt-2 pt-2 profile-menu-divider profile-menu-section p-2">
        <div class="text-xs uppercase tracking-wide opacity-60 mb-1">
          {{ "COMMON.THEME" | translate }}
        </div>
        <div class="flex gap-2 flex-wrap">
          <button class="btn btn-xs" (click)="setTheme('light')">
            {{ "COMMON.THEME_LIGHT" | translate }}
          </button>
          <button class="btn btn-xs" (click)="setTheme('dark')">
            {{ "COMMON.THEME_DARK" | translate }}
          </button>
          <button class="btn btn-xs" (click)="setTheme('system')">
            {{ "COMMON.THEME_SYSTEM" | translate }}
          </button>
        </div>
      </div>
      <div class="mt-2 pt-2 profile-menu-divider profile-menu-section p-2">
        <div class="text-xs uppercase tracking-wide opacity-60 mb-1">
          Background
        </div>
        <div class="flex gap-2 flex-wrap mb-2">
          <button class="btn btn-xs" (click)="setBg('minimal')">Minimal</button>
          <button class="btn btn-xs" (click)="setBg('aurora')">Aurora</button>
          <button class="btn btn-xs" (click)="setBg('bokeh')">Bokeh</button>
        </div>
        <div class="text-xs uppercase tracking-wide opacity-60 mb-1">
          Palette
        </div>
        <div class="flex gap-2 flex-wrap mb-2">
          <button class="btn btn-xs" (click)="setPalette('default')">
            Default
          </button>
          <button class="btn btn-xs" (click)="setPalette('vaporwave')">
            Vaporwave
          </button>
          <button class="btn btn-xs" (click)="setPalette('cyber')">
            Cyber
          </button>
        </div>
        <div class="flex items-center justify-between gap-2 text-sm">
          <button class="btn btn-xs" (click)="toggleNeonEdges()">
            Neon edges
          </button>
          <button class="btn btn-xs" (click)="toggleParallax()">
            Parallax
          </button>
        </div>
      </div>
    </div>
  }
</div>
