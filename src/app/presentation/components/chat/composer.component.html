<div
  class="composer-surface surface-clear rounded-xl p-3 md:p-4"
  (dragenter)="onDragEnter($event)"
  (dragover)="onDragOver($event)"
  (dragleave)="onDragLeave($event)"
  (drop)="onDrop($event)"
>
  <form [formGroup]="form" (submit)="onSubmit()" class="w-full">
    <div class="flex flex-col gap-3">
      <div class="flex items-end gap-2 md:gap-3">
        <button
          type="button"
          class="btn btn-ghost btn-square btn-sm md:btn-md"
          [title]="'COMPOSER.ATTACH_FILES' | translate"
          [attr.aria-label]="'COMPOSER.ATTACH_FILES' | translate"
          (click)="allowUpload && fileInput.click()"
          [disabled]="!allowUpload"
          [class.opacity-50]="!allowUpload"
          [class.cursor-not-allowed]="!allowUpload"
        >
          <mat-icon fontIcon="attach_file"></mat-icon>
        </button>
        <input
          #fileInput
          id="chat-file-input"
          type="file"
          multiple
          class="hidden"
          [disabled]="!allowUpload"
          (change)="filesSelected.emit($event)"
        />

        <div class="flex-1">
          <div
            class="rounded-xl border border-base-content/20 bg-transparent focus-within:border-primary transition px-3 py-2 md:px-4 md:py-3"
            [class.drop-active]="dragging"
          >
            <textarea
              class="w-full bg-transparent outline-none resize-none leading-6 md:leading-7"
              [placeholder]="'CHAT.PLACEHOLDER' | translate"
              rows="1"
              spellcheck="true"
              formControlName="message"
              (input)="composerInput.emit($event)"
              (keydown)="keydown.emit($event)"
            ></textarea>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button
            type="submit"
            class="btn btn-primary btn-square btn-sm md:btn-md"
            [disabled]="isSending || isUploadingFiles || !form.valid"
            [class.loading]="isSending"
            [title]="'CHAT.SEND' | translate"
          >
            <mat-icon fontIcon="send"></mat-icon>
          </button>
          @if (isSending) {
            <button
              type="button"
              class="btn btn-outline btn-square btn-sm md:btn-md"
              (click)="onCancel()"
              [title]="'COMPOSER.CANCEL' | translate"
            >
              <mat-icon fontIcon="close"></mat-icon>
            </button>
          }
        </div>
      </div>

      @if (!allowUpload) {
        <div class="upload-disabled-banner" role="status" aria-live="polite">
          <mat-icon fontIcon="info"></mat-icon>
          <span>{{ "COMPOSER.UPLOADS_DISABLED" | translate }}</span>
        </div>
      }

      <div
        class="flex flex-wrap items-center justify-between gap-2 text-xs opacity-70"
      >
        <div class="hidden sm:block">{{ "CHAT.HINT" | translate }}</div>
        <div class="flex items-center gap-2">
          @if (!allowUpload) {
            <div
              class="badge badge-warning"
              [title]="'COMPOSER.UPLOADS_DISABLED' | translate"
            >
              {{ "COMPOSER.UPLOADS_DISABLED" | translate }}
            </div>
          }
          @if (isUploadingFiles) {
            <div
              class="loading loading-dots loading-xs text-info"
              [title]="'COMPOSER.UPLOADING_FILES' | translate"
            ></div>
          }
          @if (filesCount) {
            <div class="badge badge-info">
              {{ "CHAT.FILES_COUNT" | translate: { count: filesCount } }}
            </div>
          }
          <span>{{ form.get("message")?.value?.length || 0 }}/1000</span>
        </div>
      </div>

      @if (isUploadingFiles) {
        <div class="mt-2 flex items-center gap-2 text-xs text-info">
          <span class="loading loading-spinner loading-xs"></span>
          <span>{{ "COMPOSER.UPLOADING_FILES" | translate }}</span>
        </div>
      }

      @if (dragging) {
        <div class="drop-overlay" aria-hidden="true">
          <div class="drop-overlay__content">
            <mat-icon
              fontIcon="cloud_upload"
              class="text-5xl md:text-6xl"
            ></mat-icon>
            <div class="mt-2 text-base md:text-lg font-semibold">
              {{ "COMPOSER.DROP_HINT" | translate }}
            </div>
          </div>
        </div>
      }

      @if (uploadedFiles.length) {
        <div class="mt-2 flex flex-wrap gap-2 text-xs">
          @for (f of uploadedFiles; track f.id) {
            <span class="badge badge-outline items-center gap-1">
              <a
                class="inline-flex items-center hover:underline"
                [href]="f.url"
                target="_blank"
                rel="noopener noreferrer"
                title="{{ f.filename }}"
              >
                <mat-icon fontIcon="insert_drive_file" class="mr-1"></mat-icon>
                <span class="truncate max-w-48">{{ f.filename }}</span>
              </a>
              <button
                type="button"
                class="btn btn-ghost btn-xs p-0 min-h-0 h-5 w-5"
                (click)="onRemove(f, $event)"
                [title]="'COMPOSER.REMOVE_FILE' | translate"
              >
                <mat-icon fontIcon="close"></mat-icon>
              </button>
            </span>
          }
        </div>
      }
    </div>
  </form>
</div>
