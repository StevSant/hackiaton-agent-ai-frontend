<div class="flex-1 flex flex-col gap-4 min-h-0">
  <div
    #messagesContainer
    class="messages-container flex-1 min-h-0 overflow-y-auto p-4 space-y-4 surface-clear rounded-xl relative"
    (scroll)="onMessagesScroll()"
  >
    <style>
      .messages-container {
        contain: content;
        content-visibility: auto;
        will-change: scroll-position;
      }
      @media (max-width: 480px) {
        .messages-container {
          padding: 0.75rem;
        }
      }
    </style>

    @if (messages.length === 0 && !isSending) {
      <div class="empty-state">
        <div class="empty-state-content">
          <div class="empty-state-icon">
            <mat-icon fontIcon="chat_bubble_outline"></mat-icon>
          </div>
          <h4 class="empty-state-title">
            {{ "CHAT.EMPTY.TITLE" | translate }}
          </h4>
          <p class="empty-state-subtitle">
            {{ "CHAT.EMPTY.SUBTITLE" | translate }}
          </p>
          <div class="empty-state-suggestions">
            <div class="suggestion-item">
              <mat-icon fontIcon="lightbulb_outline"></mat-icon>
              <span>Pregunta sobre análisis financiero</span>
            </div>
            <div class="suggestion-item">
              <mat-icon fontIcon="assessment"></mat-icon>
              <span>Solicita un reporte de empresa</span>
            </div>
            <div class="suggestion-item">
              <mat-icon fontIcon="help_outline"></mat-icon>
              <span>Pide ayuda con decisiones de crédito</span>
            </div>
          </div>
        </div>
      </div>
    }

    @for (
      message of messages;
      track chatUtils.trackByMessageId($index, message)
    ) {
      @if (chatUtils.isUserMessage(message)) {
        <div
          class="chat chat-end msg-user mb-3 pb-4 md:mb-4 md:pb-8 text-right flex items-end flex-col"
        >
          <div class="chat-header mb-1">
            <span class="text-xs opacity-60">{{
              chatUtils.getEventLabel(message.event)
            }}</span>
            <time class="text-xs opacity-60 ml-2">{{
              chatUtils.formatTimestamp(message.timestamp)
            }}</time>
          </div>
          <div
            class="chat-bubble bg-transparent surface-clear w-full max-w-[85%] sm:max-w-xs md:max-w-md lg:max-w-lg py-2 px-3 sm:px-4 rounded-lg relative overflow-hidden"
          >
            <button
              class="absolute -top-2 -left-2 btn btn-ghost btn-xs opacity-70 hover:opacity-100 z-10"
              type="button"
              title="Copiar mensaje"
              (click)="copyUserMessage(message)"
            >
              <mat-icon [fontIcon]="copiedRecently(message) ? 'check' : 'content_copy'" class="text-xs"></mat-icon>
            </button>
            <div class="break-words overflow-wrap-anywhere text-sm sm:text-base">
              {{ message.displayedContent }}
            </div>
    @if (message.file_ids?.length) {
              <div class="mt-2 pt-2 border-t attachment-row">
                <div class="text-xs font-semibold mb-1 opacity-80">
                  {{ 'COMMON.FILES' | translate }} ({{ (message.file_ids || []).length }})
                </div>
                <div class="flex flex-wrap gap-2">
                  @for (fid of message.file_ids; track fid) {
                    <a
                      class="badge badge-outline no-underline hover:badge-primary"
                      [href]="chatUtils.fileUrl(fid)"
                      target="_blank"
                      rel="noopener"
                      title="Abrir adjunto"
                    >
                      <mat-icon fontIcon="attach_file" class="mr-1 text-xs"></mat-icon>
                      <span class="truncate max-w-[12rem]">{{ fid }}</span>
                    </a>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }

      @if (chatUtils.isBotMessage(message)) {
        <div class="chat chat-start msg-bot mb-3 md:mb-4">
          <div class="chat-header mb-1">
            <span class="text-xs opacity-60">{{
              chatUtils.getEventLabel(message.event)
            }}</span>
            <time class="text-xs opacity-60 ml-2">{{
              chatUtils.formatTimestamp(message.timestamp)
            }}</time>
            @if (message.isStreaming) {
              <span class="loading loading-dots loading-xs ml-2"></span>
            }
          </div>
          <div
            class="chat-bubble bg-transparent surface-clear w-full max-w-[95%] sm:max-w-md md:max-w-lg lg:max-w-2xl xl:max-w-4xl py-2 px-3 sm:px-4 rounded-lg relative overflow-hidden"
          >
            <button
              class="absolute -top-2 -right-2 btn btn-ghost btn-xs opacity-70 hover:opacity-100 z-10"
              type="button"
              title="Copiar Markdown"
              (click)="copyAgentMarkdown(message)"
            >
              <mat-icon [fontIcon]="copiedRecently(message) ? 'check' : 'content_copy'" class="text-xs"></mat-icon>
            </button>
            <div class="prose prose-sm w-full max-w-none overflow-hidden break-words">
              @let view = getProcessed(message);
              @if (view.main.length) {
                <markdown [data]="view.main"></markdown>
              }
              @if ((view.charts.length || 0) > 0) {
                <div class="mt-3 grid gap-3">
                  @for (cfg of view.charts; track $index) {
                    <app-lazy-chart [chartType]="cfg.type" [data]="cfg.data" [options]="cfg.options"></app-lazy-chart>
                  }
                </div>
              }
              @if (view.thinks.length) {
                <div class="mt-3 think-section">
                  <button
                    class="btn btn-ghost btn-xs think-toggle-btn"
                    type="button"
                    (click)="toggleThink(message)"
                  >
                    <mat-icon
                      [fontIcon]="
                        view.expanded ? 'expand_less' : 'expand_more'
                      "
                      class="mr-1"
                    ></mat-icon>
                    {{
                      view.expanded
                        ? ("CHAT.HIDE_THINK" | translate)
                        : ("CHAT.SHOW_THINK" | translate)
                    }}
                    <span class="think-count ml-1">({{ view.thinks.length }})</span>
                  </button>
                  @if (view.expanded) {
                    <div class="think-container">
                      @for (t of view.thinks; track $index) {
                        <div class="think-block">
                          <div class="think-header">
                            <mat-icon fontIcon="psychology"></mat-icon>
                            <span>Proceso de pensamiento {{ $index + 1 }}</span>
                          </div>
                          <div class="think-content">
                            <markdown [data]="t"></markdown>
                          </div>
                        </div>
                      }
                    </div>
                  }
                </div>
              }
            </div>

            @if (message.extra_data?.reasoning_steps?.length) {
              <div class="mt-3 border-t pt-2">
                <div class="text-xs font-semibold mb-1">Razonamiento</div>
                <ul class="list-disc ml-5 text-xs space-y-1">
                  @for (
                    step of message.extra_data?.reasoning_steps;
                    track step.title
                  ) {
                    <li>
                      <div class="font-medium">{{ step.title }}</div>
                      <div class="opacity-80">{{ step.reasoning }}</div>
                      @if (step.result) {
                        <div class="opacity-70">→ {{ step.result }}</div>
                      }
                    </li>
                  }
                </ul>
              </div>
            }

            @if (message.extra_data?.references?.length) {
              <div class="mt-3 border-t pt-2">
                <div class="text-xs font-semibold mb-1">Referencias</div>
                <ul class="list-disc ml-5 text-xs space-y-1">
                  @for (
                    block of message.extra_data?.references;
                    track block.query
                  ) {
                    <li>
                      <div class="font-medium">Consulta: {{ block.query }}</div>
                      <ul class="list-disc ml-5">
                        @for (ref of block.references; track ref.name) {
                          <li>
                            <div class="opacity-90">{{ ref.name }}</div>
                            <div class="opacity-70">{{ ref.content }}</div>
                          </li>
                        }
                      </ul>
                    </li>
                  }
                </ul>
              </div>
            }

            @if (message.images?.length) {
              <div class="mt-2 grid grid-cols-2 gap-2">
                @for (img of message.images; track img.url) {
                  <img
                    [src]="img.url"
                    alt="media"
                    class="rounded-md max-h-48 object-cover"
                  />
                }
              </div>
            }

            @if (message.videos?.length) {
              <div class="mt-2 space-y-2">
                @for (v of message.videos; track v.url) {
                  <video class="rounded-md w-full" controls [src]="v.url">
                    <track kind="captions" />
                  </video>
                }
              </div>
            }

            @if (
              chatUtils.isBotMessage(message) &&
              message.content.trim() &&
              !message.isStreaming
            ) {
              <div class="tts-controls">
                <div class="tts-buttons">
                  @if (!isPlayingFor(message.id)) {
                    <button
                      class="tts-btn tts-play-btn"
                      (click)="playTTS(message)"
                      title="Reproducir"
                    >
                      <mat-icon fontIcon="play_arrow"></mat-icon>
                      <span>Reproducir</span>
                    </button>
                  } @else {
                    <button
                      class="tts-btn tts-pause-btn"
                      (click)="
                        isPausedFor(message.id) ? tts.resume() : tts.pause()
                      "
                      title="Pausar/Reanudar"
                    >
                      <mat-icon
                        [fontIcon]="
                          isPausedFor(message.id) ? 'play_arrow' : 'pause'
                        "
                      ></mat-icon>
                      <span>{{ isPausedFor(message.id) ? 'Reanudar' : 'Pausar' }}</span>
                    </button>
                  }
                  
                  <button
                    class="tts-btn tts-stop-btn"
                    (click)="ttsStop()"
                    title="Detener"
                    [disabled]="!isPlayingFor(message.id) && !isPausedFor(message.id)"
                  >
                    <mat-icon fontIcon="stop"></mat-icon>
                  </button>
                </div>

                <div class="volume-control">
                  <mat-icon fontIcon="volume_up" class="volume-icon"></mat-icon>
                  <input
                    type="range"
                    min="0"
                    max="1"
                    step="0.05"
                    [value]="tts.volume()"
                    (input)="onVolumeInput($event)"
                    class="volume-slider"
                  />
                  <span class="volume-text">{{ tts.volume() * 100 | number: "1.0-0" }}%</span>
                </div>
              </div>
            }

            @if (
              message.isStreaming &&
              message.displayedContent.length < message.content.length
            ) {
              <span
                class="inline-block w-1 h-4 bg-current animate-pulse ml-1 opacity-70"
              ></span>
            }
          </div>
        </div>
      }

      @if (chatUtils.isSystemMessage(message)) {
        <div class="flex justify-center my-2 msg-system">
          <div
            class="flex items-center gap-2 px-4 py-2 bg-info/10 text-info rounded-full text-sm"
          >
            <span class="opacity-70">{{
              chatUtils.formatTimestamp(message.timestamp)
            }}</span>
            <span>{{ message.displayedContent }}</span>
          </div>
        </div>
      }
    }

    @if (toolRunning) {
      <div class="tool-running-indicator">
        <div class="tool-running-content">
          <div class="tool-running-animation">
            <div class="tool-loading-dots"></div>
          </div>
          <div class="tool-running-text">
            <span class="tool-running-title">{{ "CHAT.RUNNING_TOOLS" | translate }}</span>
            <span class="tool-running-subtitle">Procesando información...</span>
          </div>
        </div>
      </div>
    }

    @if (showScrollToBottom) {
      <button
        type="button"
        class="btn btn-primary btn-circle scroll-to-bottom-btn shadow-lg"
        (click)="scrollToBottom()"
        title="Bajar al final"
      >
        <mat-icon fontIcon="arrow_downward"></mat-icon>
      </button>
    }
  </div>
</div>
