<div
  class="modal-backdrop"
  (click)="onBackdropClick()"
  (keydown)="$event.stopPropagation()"
>
  <dialog
    #modalRoot
    open
    class="modal"
    (click)="$event.stopPropagation()"
    (keydown)="onKeydown($event)"
  >
    <header class="modal-header">
      <h3>{{ "CHAT.COMPANIES_ANALYSIS_TITLE" | translate }}</h3>
      <button
        #closeBtn
        type="button"
        class="btn btn-ghost btn-sm"
        (click)="closed.emit()"
        [attr.aria-label]="'COMPOSER.CANCEL' | translate"
      >
        <mat-icon fontIcon="close"></mat-icon>
      </button>
    </header>

    <section class="modal-body" *ngIf="!loading(); else loadingTpl">
      <div *ngIf="error()" class="error">
        <div>{{ error() }}</div>
      </div>
      <ng-container *ngIf="data() as d">
        <div *ngIf="!d || d.company_count === 0" class="empty">
          <div>{{ "CHAT.COMPANIES_ANALYSIS_EMPTY" | translate }}</div>
        </div>
        <div *ngIf="d && d.company_count > 0" class="content">
          <h4>{{ "CHAT.COMPANIES_ANALYSIS_COMPANIES" | translate }}</h4>
          <ul class="companies">
            <li
              *ngFor="let c of d.companies; trackBy: trackByTaxId"
              class="card"
            >
              <div class="row" *ngIf="c.dashboard?.company as comp">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">badge</mat-icon>
                  Empresa
                </div>
                <div class="col val">
                  {{ comp?.business_name || comp?.name || comp?.razon_social || comp?.legal_name || comp?.nombre || '—' }}
                </div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.legal_status as ls">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">verified</mat-icon>
                  Estado legal
                </div>
                <div class="col val">{{ ls }}</div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.ciiu as ciiu">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">category</mat-icon>
                  CIIU
                </div>
                <div class="col val">{{ ciiu }}</div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.company_type as ctype">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">apartment</mat-icon>
                  Tipo
                </div>
                <div class="col val">{{ ctype }}</div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.incorporation_date as incd">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">event</mat-icon>
                  Constitución
                </div>
                <div class="col val">{{ incd }}</div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.address as addr">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">place</mat-icon>
                  Dirección
                </div>
                <div class="col val">{{ addr }}</div>
              </div>
      <div class="row" *ngIf="c.dashboard?.company?.representatives?.length as repsLen">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">groups</mat-icon>
                  Representantes
                </div>
                <div class="col val">
                  <ul>
        <li *ngFor="let r of (c.dashboard?.company?.representatives || [])">
                      {{ r?.nombre || r?.name || '—' }}
                      <span *ngIf="r?.identificacion || r?.id">
                        ({{ r?.identificacion || r?.id }})
                      </span>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.additional as add">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">info</mat-icon>
                  Extras
                </div>
                <div class="col val">
                  <div class="ins-pills">
                    <span class="pill" *ngIf="add?.belongs_to_mv">Pertenece a MV</span>
                    <span class="pill" *ngIf="add?.is_state_supplier">Proveedor del Estado</span>
                    <span class="pill" *ngIf="add?.offers_remittances">Ofrece remesas</span>
                    <span class="pill" *ngIf="add?.sells_on_credit">Vende a crédito</span>
                    <span class="pill" *ngIf="add?.is_public_interest">Interés público</span>
                    <span class="pill" *ngIf="add?.is_bic">Empresa BIC</span>
                    <span class="pill warn" *ngIf="add?.judicial_disposition && add.judicial_disposition !== 'NINGUNA'">
                      Medida judicial: {{ add.judicial_disposition }}
                    </span>
                  </div>
                  <div class="text-xs mt-1" *ngIf="add?.last_corp_update_at">
                    Últ. actualización corporativa: {{ add.last_corp_update_at }}
                  </div>
                </div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.source_url as url">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">link</mat-icon>
                  Fuente
                </div>
                <div class="col val"><a [href]="url" target="_blank" rel="noopener">{{ url }}</a></div>
              </div>
              <div class="row" *ngIf="c.dashboard?.company?.fetched_at as fa">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">schedule</mat-icon>
                  Capturado
                </div>
                <div class="col val">{{ fa }}</div>
              </div>
              <div class="row">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">business</mat-icon>
                  RUC
                </div>
                <div class="col val">{{ c.tax_id }}</div>
              </div>
              <div class="row" *ngIf="c.dashboard as dash">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">analytics</mat-icon>
                  {{ "CHAT.COMPANY_SCORE" | translate }}
                </div>
                <div class="col val">
                  <span *ngIf="dash?.score as s"
                    >{{ s?.score ?? "—" }} ({{ s?.risk_class || "N/D" }})</span
                  >
                  <span *ngIf="!dash?.score">—</span>
                </div>
              </div>
              <div class="row" *ngIf="c.dashboard?.score?.recommended_credit_limit as rcl">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">credit_score</mat-icon>
                  Límite recomendado
                </div>
                <div class="col val">{{ rcl | number:'1.0-0' }}</div>
              </div>
              <div class="row" *ngIf="c.insights as ins">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">lightbulb</mat-icon>
                  {{ "CHAT.INSIGHTS" | translate }}
                </div>
                <div class="col val">
                  <div class="ins-item" *ngIf="ins?.credit_recommendation">
                    <mat-icon class="text-sm mr-1">recommend</mat-icon>
                    {{ ins.credit_recommendation }}
                  </div>
                  <div class="ins-item" *ngIf="ins?.risk_summary">
                    <mat-icon class="text-sm mr-1">assessment</mat-icon>
                    {{ ins.risk_summary }}
                  </div>
                  <div class="ins-item" *ngIf="ins?.reputation">
                    <mat-icon class="text-sm mr-1">stars</mat-icon>
                    {{ ins.reputation }}
                  </div>
                  <div class="ins-item" *ngIf="ins?.narrative">
                    <mat-icon class="text-sm mr-1">description</mat-icon>
                    {{ ins.narrative }}
                  </div>
                  <div class="ins-pills">
                    <span
                      class="pill"
                      *ngFor="let k of (ins?.key_factors || []).slice(0, 4)"
                      >{{ k }}</span
                    >
                    <span
                      class="pill warn"
                      *ngFor="let w of (ins?.warnings || []).slice(0, 3)"
                      >{{ w }}</span
                    >
                  </div>
                  <div class="ins-pills" *ngIf="ins?.suggested_actions?.length">
                    <mat-icon class="text-sm mr-1">checklist</mat-icon>
                    <span class="pill" *ngFor="let a of (ins?.suggested_actions || []).slice(0,4)">
                      {{ a }}
                    </span>
                  </div>
                  <div class="ins-pills" *ngIf="ins?.opportunity_zones?.length">
                    <mat-icon class="text-sm mr-1">trending_up</mat-icon>
                    <span class="pill" *ngFor="let o of (ins?.opportunity_zones || []).slice(0,4)">
                      {{ o }}
                    </span>
                  </div>
                  <div class="ins-pills" *ngIf="ins?.early_alerts?.length">
                    <mat-icon class="text-sm mr-1">warning_amber</mat-icon>
                    <span class="pill warn" *ngFor="let e of (ins?.early_alerts || []).slice(0,4)">
                      {{ e }}
                    </span>
                  </div>
                  <div class="ins-pills" *ngIf="ins?.data_quality_flags?.length">
                    <mat-icon class="text-sm mr-1">flag</mat-icon>
                    <span class="pill" *ngFor="let f of (ins?.data_quality_flags || []).slice(0,4)">
                      {{ f }}
                    </span>
                  </div>
                </div>
              </div>
              <div class="row" *ngIf="$any(c.dashboard)?.missing_data?.length">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">help_center</mat-icon>
                  Datos faltantes
                </div>
                <div class="col val">
                  <div class="ins-pills">
                    <span class="pill warn" *ngFor="let m of $any(c.dashboard)?.missing_data">{{ m }}</span>
                  </div>
                  <div class="text-xs mt-1" *ngIf="$any(c.dashboard)?.imputation?.error as impErr">
                    {{ impErr }}
                  </div>
                </div>
              </div>
              <div class="row" *ngIf="c.dashboard?.score_source as src">
                <div class="col key">
                  <mat-icon class="text-sm mr-1">workspaces</mat-icon>
                  Fuente de score
                </div>
                <div class="col val">{{ src }}</div>
              </div>
              <div *ngIf="c.error" class="row error">
                <mat-icon class="text-sm mr-1">error</mat-icon>
                {{ c.error }}
              </div>
            </li>
          </ul>

          <div class="aggregate" *ngIf="d.aggregate_insights as agg">
            <h4>{{ "CHAT.AGGREGATE_SUMMARY" | translate }}</h4>
            <p class="mb-2" *ngIf="agg?.overview">{{ agg.overview }}</p>
            <div class="ranking" *ngIf="agg?.ranking?.length">
              <div class="row head">
                <div>
                  <mat-icon class="text-sm">tag</mat-icon>
                  #
                </div>
                <div>
                  <mat-icon class="text-sm">business</mat-icon>
                  RUC
                </div>
                <div>
                  <mat-icon class="text-sm">analytics</mat-icon>
                  {{ "CHAT.COMPANY_SCORE" | translate }}
                </div>
                <div>
                  <mat-icon class="text-sm">warning</mat-icon>
                  {{ "COMMON.RISK" | translate }}
                </div>
              </div>
              <div class="row" *ngFor="let r of agg.ranking">
                <div>{{ r.position ?? "—" }}</div>
                <div>{{ r.tax_id }}</div>
                <div>{{ r.score ?? "—" }}</div>
                <div>{{ r.risk_class || "—" }}</div>
              </div>
            </div>
            <div class="mt-3" *ngIf="agg?.common_opportunities?.length">
              <h5>
                <mat-icon class="text-sm mr-1">trending_up</mat-icon>
                Oportunidades comunes
              </h5>
              <div class="ins-pills">
                <span class="pill" *ngFor="let o of agg.common_opportunities">{{ o }}</span>
              </div>
            </div>
            <div class="mt-3" *ngIf="agg?.common_risks?.length">
              <h5>
                <mat-icon class="text-sm mr-1">warning</mat-icon>
                Riesgos comunes
              </h5>
              <div class="ins-pills">
                <span class="pill warn" *ngFor="let r of agg.common_risks">{{ r }}</span>
              </div>
            </div>
            <div class="mt-3" *ngIf="agg?.diversification_comment">
              <h5>
                <mat-icon class="text-sm mr-1">scatter_plot</mat-icon>
                Diversificación
              </h5>
              <p>{{ agg.diversification_comment }}</p>
            </div>
            <div class="mt-3" *ngIf="agg?.action_recommendations?.length">
              <h5>
                <mat-icon class="text-sm mr-1">checklist</mat-icon>
                Recomendaciones
              </h5>
              <ul>
                <li *ngFor="let a of agg.action_recommendations">{{ a }}</li>
              </ul>
            </div>
          </div>
        </div>
      </ng-container>
    </section>

    <ng-template #loadingTpl>
      <div class="loading">
        <div class="spinner">
          <mat-icon class="animate-spin">autorenew</mat-icon>
        </div>
        <div class="loading-text">
          {{ "COMMON.LOADING" | translate }}...
        </div>
      </div>
    </ng-template>
  </dialog>
</div>
