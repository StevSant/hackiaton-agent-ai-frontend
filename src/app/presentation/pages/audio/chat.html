<div class="flex min-h-screen h-full relative bg-base-200">
  <!-- Sidebar placeholder - puedes agregar tu sidebar aqu√≠ -->

  <div class="chat-container h-screen w-full p-4 md:p-8 flex flex-col gap-4 max-h-screen">
    <!-- Header mejorado -->
    <div
      class="chat-header w-full flex flex-col md:flex-row justify-between items-center gap-4 p-4 bg-base-100 rounded-xl shadow-sm">
      <div class="text-center md:text-left">
        <h3 class="text-2xl md:text-3xl font-bold flex items-center gap-2">
          ü§ñ
          <span class="bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">
            Chat con Agente
          </span>
        </h3>
  <p class="text-sm opacity-70 mt-1">Agente: {{ agentIdValue() }} <span *ngIf="selectedSessionId">¬∑ Sesi√≥n: {{ selectedSessionId }}</span></p>
      </div>

      <!-- Estado de conexi√≥n mejorado -->
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-2 px-3 py-2 rounded-full bg-base-200">
          <div class="w-3 h-3 rounded-full transition-all duration-300" [class]="getConnectionStatusClass()"></div>
          <span class="text-sm font-medium">{{
            getConnectionStatusText()
            }}</span>
        </div>

        <!-- Controles de sesi√≥n y contador -->
        @if (messages.length > 0) {
        <div class="badge badge-outline">
          {{ messages.length }} mensaje{{
          messages.length !== 1 ? 's' : ''
          }}
        </div>
        }


      </div>
    </div>

    <!-- Contenedor de chat -->
    <div class="flex-1 flex flex-col gap-4 min-h-0">
      <!-- Contenedor de mensajes con scroll -->
      <div #messagesContainer
        class="messages-container flex-1 overflow-y-auto p-4 space-y-4 bg-base-100 rounded-xl shadow-sm"
        style="max-height: calc(100vh - 250px);">
        <!-- Estado vac√≠o mejorado -->
        @if (messages.length === 0 && !isSending) {
        <div class="flex flex-col items-center justify-center h-full min-h-[300px] text-center">
          <div class="text-6xl mb-4">üí¨</div>
          <h4 class="text-xl font-semibold mb-2">
            ¬°Comienza una conversaci√≥n!
          </h4>
          <p class="text-base-content/70 max-w-md">
            Escribe tu mensaje abajo para comenzar a chatear con el agente
            de IA.
          </p>
        </div>
        }

        <!-- Mensajes -->
        @for (message of messages; track trackByMessageId($index, message))
        {

        <!-- Mensaje del Usuario -->
        @if (isUserMessage(message)) {
        <div class="chat chat-end">
          <div class="chat-header mb-1">
            <span class="text-xs opacity-60">{{
              getEventLabel(message.event)
              }}</span>
            <time class="text-xs opacity-60 ml-2">{{
              formatTimestamp(message.timestamp)
              }}</time>
          </div>
          <div class="chat-bubble chat-bubble-primary max-w-xs md:max-w-md lg:max-w-lg">
            {{ message.displayedContent }}
          </div>
        </div>
        }

        <!-- Mensaje del Bot -->
        @if (isBotMessage(message)) {
        <div class="chat chat-start">
          <div class="chat-header mb-1">
            <span class="text-xs opacity-60">{{
              getEventLabel(message.event)
              }}</span>
            <time class="text-xs opacity-60 ml-2">{{
              formatTimestamp(message.timestamp)
              }}</time>
            @if (message.isStreaming) {
            <span class="loading loading-dots loading-xs ml-2"></span>
            }
          </div>
          <div class="chat-bubble bg-base-200 text-base-content max-w-xs md:max-w-md lg:max-w-2xl">
            <div class="prose prose-sm max-w-none">
              <!-- {{ message.displayedContent }} -->
              <markdown [data]="message.displayedContent"></markdown>
            </div>
            <!-- TTS controls for this bot message -->
            @if (supportsSpeechSynthesis) {
            <div class="mt-2 flex items-center gap-2 text-xs">
              <span class="opacity-70">Leer:</span>
              <button class="btn btn-ghost btn-xs" (click)="ttsPlay(message)" [disabled]="ttsState==='playing' && ttsMessageId===message.id">‚ñ∂</button>
              <button class="btn btn-ghost btn-xs" (click)="ttsPause()" [disabled]="!(ttsState==='playing' && ttsMessageId===message.id)">‚è∏</button>
              <button class="btn btn-ghost btn-xs" (click)="ttsResume()" [disabled]="ttsState!=='paused' || ttsMessageId!==message.id">‚èØ</button>
              <button class="btn btn-ghost btn-xs" (click)="ttsStop()" [disabled]="ttsMessageId!==message.id">‚èπ</button>
            </div>
            }
            <!-- Reasoning steps -->
            @if (message.extra_data?.reasoning_steps?.length) {
            <div class="mt-3 border-t pt-2">
              <div class="text-xs font-semibold mb-1">Razonamiento</div>
              <ul class="list-disc ml-5 text-xs space-y-1">
                @for (step of message.extra_data?.reasoning_steps; track step.title) {
                <li>
                  <div class="font-medium">{{ step.title }}</div>
                  <div class="opacity-80">{{ step.reasoning }}</div>
                  @if (step.result) { <div class="opacity-70">‚Üí {{ step.result }}</div> }
                </li>
                }
              </ul>
            </div>
            }
            <!-- References -->
            @if (message.extra_data?.references?.length) {
            <div class="mt-3 border-t pt-2">
              <div class="text-xs font-semibold mb-1">Referencias</div>
              <ul class="list-disc ml-5 text-xs space-y-1">
                @for (block of message.extra_data?.references; track block.query) {
                <li>
                  <div class="font-medium">Consulta: {{ block.query }}</div>
                  <ul class="list-disc ml-5">
                    @for (ref of block.references; track ref.name) {
                    <li>
                      <div class="opacity-90">{{ ref.name }}</div>
                      <div class="opacity-70">{{ ref.content }}</div>
                    </li>
                    }
                  </ul>
                </li>
                }
              </ul>
            </div>
            }
            <!-- Media: images/videos/audio -->
            @if (message.images?.length) {
            <div class="mt-2 grid grid-cols-2 gap-2">
              @for (img of message.images; track img.url) {
              <img [src]="img.url" alt="media" class="rounded-md max-h-48 object-cover" />
              }
            </div>
            }
            @if (message.videos?.length) {
            <div class="mt-2 space-y-2">
              @for (v of message.videos; track v.url) {
              <video class="rounded-md w-full" controls [src]="v.url">
                <track kind="captions" />
              </video>
              }
            </div>
            }
            @if (message.audio?.length) {
            <div class="mt-2 space-y-2">
              @for (a of message.audio; track a.id) {
              <audio controls [src]="getAudioSrc(a)"></audio>
              }
            </div>
            }
            @if (message.response_audio?.transcript) {
            <div class="mt-2 text-xs opacity-80">Transcripci√≥n: {{ message.response_audio?.transcript }}</div>
            }
            @if (message.isStreaming && message.displayedContent.length < message.content.length) { <span
              class="inline-block w-2 h-4 bg-current animate-pulse ml-1"></span>
              }
          </div>
        </div>
        }

        <!-- Mensaje del Sistema -->
        @if (isSystemMessage(message)) {
        <div class="flex justify-center my-2">
          <div class="flex items-center gap-2 px-4 py-2 bg-info/10 text-info rounded-full text-sm">
            <span class="opacity-70">{{
              formatTimestamp(message.timestamp)
              }}</span>
            <span>{{ message.displayedContent }}</span>
          </div>
        </div>
        } }

        <!-- Indicador de carga principal (al inicio del chat) -->
        @if (isSending && messages.length <= 1) { <div class="flex justify-center items-center py-8">
          <div class="flex flex-col items-center gap-4">
            <div class="loading loading-dots loading-lg text-primary"></div>
            <p class="text-base-content/70">
              El agente est√° procesando tu mensaje...
            </p>
          </div>
      </div>
      }

      <!-- Loader sutil cuando se ejecutan herramientas -->
      @if (toolRunning) {
      <div class="flex justify-center items-center py-2">
        <div class="loading loading-dots loading-sm text-info" aria-label="Ejecutando herramientas"></div>
        <span class="text-xs ml-2 text-info/80">Ejecutando herramientas‚Ä¶</span>
      </div>
      }
    </div>

    <!-- Controles de voz y formulario -->
    <div class="bg-base-100 rounded-xl shadow-sm p-4">
      <div class="w-full flex items-center justify-center gap-4 mb-4">
        <button type="button" class="btn btn-circle btn-lg" [class.btn-error]="isRecording" [class.btn-primary]="!isRecording" (click)="toggleRecording()">
          <span *ngIf="!isRecording">üé§</span>
          <span *ngIf="isRecording">‚èπÔ∏è</span>
        </button>
        <div class="text-sm opacity-70">
          {{ isRecording ? 'Grabando... toca para detener' : 'Toca para grabar un mensaje de voz' }}
        </div>
        @if (isRecording && isTranscribing) {
          <div class="badge badge-outline">Transcribiendo‚Ä¶</div>
        }
      </div>
      @if (!supportsSpeechRecognition) {
        <div class="alert alert-warning text-sm mb-2">
          Tu navegador no soporta reconocimiento de voz (Web Speech API). Escribe tu mensaje o adjunta audio.
        </div>
      }
      @if (sttError) {
        <div class="text-error text-sm mb-2">{{ sttError }}</div>
      }
      <div *ngIf="micError" class="text-error text-sm mt-2 text-center">{{ micError }}</div>

  <form [formGroup]="msgForm" (submit)="sendMessage()" class="w-full">
        <div class="flex items-end gap-3">
          <!-- Input de mensaje editable -->
          <div class="flex-1">
            <textarea class="textarea textarea-bordered w-full resize-none min-h-[60px] max-h-[120px]"
              placeholder="Escribe tu mensaje aqu√≠... (Shift + Enter para nueva l√≠nea)" rows="2"
              formControlName="message" (keydown)="handleKeyDown($event)"></textarea>

            <!-- Mensajes de error -->
            @if (msgForm.get('message')?.invalid && msgForm.get('message')?.touched) {
            <div class="text-error text-sm mt-1">
              Por favor, escribe un mensaje o adjunta un archivo/audio.
            </div>
            }
          </div>

          <!-- Bot√≥n de env√≠o -->
          <div class="flex flex-col gap-2 items-end">
            <button type="submit" class="btn btn-primary" [disabled]="isSending"
              [class.loading]="isSending">
              {{ isSending ? 'Enviando...' : 'Enviar' }}
            </button>

            @if (isSending) {
            <button type="button" class="btn btn-outline btn-sm" (click)="cancelSending()">
              Cancelar
            </button>
            }
            <div class="flex items-center gap-2 text-xs mt-1">
              <input type="checkbox" class="checkbox checkbox-sm" [(ngModel)]="includeAudioOriginal" [ngModelOptions]="{standalone: true}" name="includeAudioOriginal" />
              <label for="includeAudioOriginal">Adjuntar audio original</label>
            </div>
          </div>
        </div>

        <div class="flex justify-between items-center mt-2 gap-2">
          <div class="text-xs opacity-60">Adjunta archivos (PDF, im√°genes) opcionalmente</div>
          <div class="flex items-center gap-3">
            <input type="file" accept="application/pdf,image/*" multiple class="file-input file-input-bordered file-input-sm"
              (change)="onFilesSelected($event)" />
            <span class="text-xs opacity-60">{{ msgForm.get('message')?.value?.length || 0 }}/1000</span>
          </div>
        </div>
  @if (attachments.length) {
          <div class="mt-2 text-xs opacity-70">Adjuntos: {{ attachments.length }} archivo(s)</div>
        }
      </form>
      @if (supportsSpeechSynthesis) {
      <div class="mt-3 flex items-center gap-3">
        <span class="text-xs opacity-70">Volumen TTS</span>
        <input type="range" min="0" max="1" step="0.05" [ngModel]="ttsVolume" (ngModelChange)="setTtsVolume($event)" class="range range-xs w-48" />
      </div>
      }
    </div>
  </div>
</div>
</div>