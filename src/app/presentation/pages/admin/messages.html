<link rel="stylesheet" href="./messages.css">
<div class="messages-container vt-page">
  <!-- Header Section -->
  <div class="messages-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-comments title-icon"></i>
        {{ "ADMIN.MESSAGES.TITLE" | translate }}
      </h1>
      <p class="page-subtitle">
        Gestiona y revisa las conversaciones del sistema
      </p>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="messages-grid">
    <!-- Sessions Panel -->
    <div class="sessions-panel modern-card">
      <div class="panel-header">
        <h3 class="panel-title">
          <i class="fas fa-list"></i>
          Sesiones de Chat
        </h3>
      </div>
      
      <!-- Search Section -->
      <div class="search-section">
        <div class="search-input-group">
          <i class="fas fa-search search-icon"></i>
          <input
            class="search-input"
            [placeholder]="'ADMIN.MESSAGES.SEARCH_PLACEHOLDER' | translate"
            #q
            (keyup.enter)="applySessionsSearch(q.value)"
          />
          <button class="search-btn" (click)="applySessionsSearch(q.value)">
            <i class="fas fa-filter"></i>
            <span>{{ "ADMIN.MESSAGES.FILTER" | translate }}</span>
          </button>
        </div>
      </div>

      <!-- Sessions List -->
      <div class="sessions-list" #sessionsContainer>
        @for (s of sessions(); track s.session_id) {
          <button
            class="session-item"
            (click)="open(s.session_id)"
            [class.active]="selected() === s.session_id"
          >
            <div class="session-main">
              <div class="session-title">
                <i class="fas fa-comment-dots session-icon"></i>
                <span>{{ s.title || s.session_id }}</span>
              </div>
              <div class="session-meta">
                <div class="meta-item">
                  <i class="fas fa-clock"></i>
                  <span>{{ s.updated_at }}</span>
                </div>
                <div class="meta-separator">•</div>
                <div class="meta-item">
                  <i class="fas fa-user"></i>
                  <span class="user-id" [attr.title]="userLabel(s.user_id)">{{
                    getCachedUserLabel(s.user_id) || s.user_id
                  }}</span>
                </div>
              </div>
            </div>
            <div class="session-indicator">
              <i class="fas fa-chevron-right"></i>
            </div>
          </button>
        }
        
        <!-- Loading Indicator -->
        <div class="loading-section" #sessionsSentinel>
          @if (loading()) {
            <div class="loading-item">
              <i class="fas fa-spinner fa-spin"></i>
              <span>{{ "COMMON.LOADING" | translate }}</span>
            </div>
          }
        </div>
      </div>

      <!-- Sessions Footer -->
      <div class="sessions-footer">
        <div class="sessions-count">
          <i class="fas fa-info-circle"></i>
          <span>{{ sessions().length }} / {{ total() || "∞" }}</span>
        </div>
      </div>
    </div>

    <!-- Messages Panel -->
    <div class="messages-panel modern-card">
      @if (!selected()) {
        <div class="empty-state">
          <div class="empty-icon">
            <i class="fas fa-message"></i>
          </div>
          <h3 class="empty-title">{{ "ADMIN.MESSAGES.SELECT_SESSION" | translate }}</h3>
          <p class="empty-description">
            Selecciona una sesión de la lista para ver los mensajes
          </p>
        </div>
      } @else {
        <!-- Messages Header -->
        <div class="messages-header-bar">
          <div class="session-info">
            <div class="session-user">
              <i class="fas fa-user-circle"></i>
              <span class="user-label" [attr.title]="userLabel(selectedOwnerId())">{{
                getCachedUserLabel(selectedOwnerId()) || selectedOwnerId()
              }}</span>
            </div>
          </div>
          
          <div class="header-actions">
            <button class="action-btn files-btn" type="button" (click)="showFilesModal = true">
              <i class="fas fa-paperclip"></i>
              <span>{{ 'CHAT.ATTACHMENTS_VIEW' | translate }}</span>
            </button>
            <button class="action-btn companies-btn" type="button" (click)="showCompaniesModal = true">
              <i class="fas fa-building"></i>
              <span>{{ 'COMMON.COMPANIES' | translate }}</span>
            </button>
          </div>
        </div>

        <!-- Messages List -->
        <div class="messages-list">
          @for (m of messages(); track m.id) {
            <div class="message-item" [class]="'message-' + m.role">
              <div class="message-header">
                <div class="message-role">
                  @if (m.role === 'user') {
                    <i class="fas fa-user"></i>
                  } @else if (m.role === 'agent') {
                    <i class="fas fa-robot"></i>
                  } @else {
                    <i class="fas fa-cog"></i>
                  }
                  <span class="role-badge">{{ m.role }}</span>
                </div>
                <div class="message-time">
                  <i class="fas fa-clock"></i>
                  <span>{{ m.created_at }}</span>
                </div>
              </div>
              
              @let view = getProcessed(m);
              <div class="message-content">
                @if (view.main.length) {
                  <div class="message-main">
                    <markdown [data]="view.main"></markdown>
                  </div>
                }
                
                @if (view.thinks.length) {
                  <div class="think-section">
                    <button
                      class="think-toggle"
                      type="button"
                      (click)="toggleThink(m)"
                    >
                      <i class="fas" [class]="view.expanded ? 'fa-eye-slash' : 'fa-eye'"></i>
                      <span>
                        {{
                          view.expanded
                            ? ("CHAT.HIDE_THINK" | translate)
                            : ("CHAT.SHOW_THINK" | translate)
                        }}
                      </span>
                    </button>
                    
                    @if (view.expanded) {
                      <div class="think-content">
                        <div class="think-header">
                          <i class="fas fa-brain"></i>
                          <span>&lt;think&gt;</span>
                        </div>
                        @for (t of view.thinks; track t) {
                          <div class="think-item">
                            <markdown [data]="t"></markdown>
                          </div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            </div>
          }
          
          <!-- Load More Indicator -->
          <div class="load-more-section" #sentinel>
            @if ((messages()?.length || 0) < msgTotal()) {
              <div class="loading-more">
                <i class="fas fa-spinner fa-spin"></i>
                <span>{{ "ADMIN.MESSAGES.LOADING_MORE" | translate }}</span>
              </div>
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Modals -->
  @if (showFilesModal && selected()) {
    <app-session-files-modal [sessionId]="selected()!" (closed)="showFilesModal = false"></app-session-files-modal>
  }
  @if (showCompaniesModal && selected()) {
    <app-session-companies-modal [sessionId]="selected()!" (closed)="showCompaniesModal = false"></app-session-companies-modal>
  }
</div>
