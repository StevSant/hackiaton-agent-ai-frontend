<div class="p-6 space-y-4 vt-page">
  <h2 class="text-xl font-semibold sticky top-0 z-20 bg-card/70 backdrop-blur rounded-md p-2">{{ 'ADMIN.COMPANIES.TITLE' | translate }}</h2>
  <form [formGroup]="form" (ngSubmit)="applySearch()" class="glass-card p-3 flex flex-wrap gap-2 items-end">
    <input class="input input-bordered flex-1 min-w-[220px]" formControlName="search" [placeholder]="'ADMIN.COMPANIES.SEARCH_PLACEHOLDER' | translate" />
    <button class="btn btn-primary" type="submit">{{ 'ADMIN.COMPANIES.SEARCH_BUTTON' | translate }}</button>
    <div class="md:ml-auto flex items-center gap-2 w-full sm:w-auto">
      <label class="text-xs" for="companies-limit">{{ 'ADMIN.COMPANIES.LIMIT' | translate }}</label>
  <select id="companies-limit" class="select select-bordered select-sm w-full sm:w-auto" [value]="limit()" (change)="limit.set(+$any($event.target).value); applySearch()">
        <option [value]="10">10</option>
        <option [value]="20">20</option>
        <option [value]="50">50</option>
      </select>
    </div>
  </form>
  <div class="glass-card p-2 flex flex-wrap gap-2 items-center">
    <span class="text-xs opacity-70">{{ 'ADMIN.COMPANIES.SECTOR' | translate }}:</span>
    <button class="badge badge-outline badge-xs" [class.badge-primary]="!selectedSector()" (click)="selectSector('')">{{ 'COMMON.ALL' | translate }}</button>
    @for (s of sectors(); track s) {
      <button class="badge badge-outline badge-xs" [class.badge-primary]="selectedSector()===s" (click)="selectSector(s)">{{ s }}</button>
    }
  </div>
  @if (error()) {
    <div class="alert alert-error">{{ error() }}</div>
  }
  <div class="overflow-x-auto glass-card">
    <table class="table table-sm users-table">
  <thead>
        <tr>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('tax_id')">{{ 'ADMIN.COMPANIES.COLUMNS.TAX_ID' | translate }}
              <span *ngIf="sortBy()==='tax_id'">{{ sortOrder()==='asc' ? '▲' : '▼' }}</span>
            </button>
          </th>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('name')">{{ 'ADMIN.COMPANIES.COLUMNS.NAME' | translate }}
              <span *ngIf="sortBy()==='name'">{{ sortOrder()==='asc' ? '▲' : '▼' }}</span>
            </button>
          </th>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('sector')">{{ 'ADMIN.COMPANIES.COLUMNS.SECTOR' | translate }}
              <span *ngIf="sortBy()==='sector'">{{ sortOrder()==='asc' ? '▲' : '▼' }}</span>
            </button>
          </th>
          <th class="text-right">{{ 'COMMON.DASHBOARD' | translate }}</th>
        </tr>
      </thead>
      <tbody class="page-stagger">
        @for (c of filteredItems(); track c.tax_id) {
          <tr>
            <td class="flex items-center gap-2">
              <span class="badge badge-outline badge-xs">{{ c.tax_id }}</span>
              <button class="btn btn-ghost btn-xs" (click)="copyTaxId(c.tax_id)" title="Copy">⧉</button>
            </td>
            <td>{{ c.name || '-' }}</td>
            <td>
              @if (c.sector) { <span class="badge badge-ghost badge-xs">{{ c.sector }}</span> } @else { - }
            </td>
            <td class="text-right">
              <button class="btn btn-outline btn-xs" (click)="openDashboard(c.tax_id)">{{ 'ADMIN.COMPANIES.OPEN_DASHBOARD' | translate }}</button>
            </td>
          </tr>
        }
      </tbody>
    </table>
  </div>
  <div class="flex flex-wrap items-center justify-end gap-2 glass-card p-2">
  <button class="btn btn-sm" (click)="prevPage()" [disabled]="page()<=1">{{ 'COMMON.PREVIOUS' | translate }}</button>
  <span class="text-sm opacity-70">{{ 'COMMON.PAGE' | translate }} {{ page() }}</span>
  <span class="text-sm opacity-60">• {{ items().length || 0 }} / {{ total() || '∞' }}</span>
  <button class="btn btn-sm" (click)="nextPage()" [disabled]="(page()*limit()) >= total()">{{ 'COMMON.NEXT' | translate }}</button>
  </div>

  <!-- Inline modal for company dashboard -->
  @if (isDashboardOpen()) {
    <dialog open class="modal modal-open" (cancel)="closeDashboard()" (click)="closeDashboard()" (keydown.escape)="closeDashboard()">
      <div class="modal-box glass-card w-[96vw] sm:w-[92vw] md:w-[88vw] lg:w-[75vw] xl:w-[70vw] max-w-none max-h-[85vh] md:max-h-[80vh] overflow-auto relative" (click)="$event.stopPropagation()" (keydown.escape)="closeDashboard()">
        <div class="flex items-center justify-between gap-2 sticky top-0 bg-base-100/80 backdrop-blur p-3 border-b">
          <h3 class="text-lg font-semibold">{{ 'ADMIN.COMPANIES.DASHBOARD_TITLE' | translate }} — {{ selectedTaxId() }}</h3>
          <button class="btn btn-ghost btn-sm" (click)="closeDashboard()">✕</button>
        </div>
        <div class="p-4 space-y-3">
          @if (companyLoading()) {
            <!-- Enhanced skeleton while loading -->
            <div class="skeleton h-6 w-40 mb-2"></div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div class="space-y-2">
                <div class="skeleton h-4 w-24"></div>
                <div class="skeleton h-6 w-36"></div>
              </div>
              <div class="space-y-2">
                <div class="skeleton h-4 w-20"></div>
                <div class="skeleton h-6 w-48"></div>
              </div>
              <div class="space-y-2">
                <div class="skeleton h-4 w-20"></div>
                <div class="skeleton h-6 w-28"></div>
              </div>
            </div>
            <div class="mt-4 space-y-2">
              <div class="skeleton h-4 w-64"></div>
              <div class="skeleton h-4 w-full"></div>
              <div class="skeleton h-4 w-5/6"></div>
            </div>
            <div class="mt-4">
              <div class="skeleton h-48 w-full"></div>
            </div>
          } @else if (companyError()) {
            <div class="alert alert-error">{{ companyError() }}</div>
          } @else if (company()) {
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div>
                <div class="text-sm opacity-70">{{ 'ADMIN.COMPANIES.COLUMNS.TAX_ID' | translate }}</div>
                <div class="font-mono flex items-center gap-2">
                  {{ company()!.tax_id }}
                  <button class="btn btn-ghost btn-xs" (click)="copyText(company()!.tax_id)" title="Copy">⧉</button>
                </div>
              </div>
              <div>
                <div class="text-sm opacity-70">{{ 'ADMIN.COMPANIES.COLUMNS.NAME' | translate }}</div>
                <div class="flex items-center gap-2">
                  {{ company()!.name || company()!.company?.business_name || '-' }}
                  @if (company()!.name || company()!.company?.business_name) { <button class="btn btn-ghost btn-xs" (click)="copyText(company()!.name || company()!.company?.business_name!)" title="Copy">⧉</button> }
                </div>
              </div>
              <div>
                <div class="text-sm opacity-70">{{ 'ADMIN.COMPANIES.COLUMNS.SECTOR' | translate }}</div>
                <div class="flex items-center gap-2">
                  {{ company()!.sector || '-' }}
                  @if (company()!.sector) { <button class="btn btn-ghost btn-xs" (click)="copyText(company()!.sector!)" title="Copy">⧉</button> }
                </div>
              </div>
              @if (company()!.company?.legal_status) {
                <div>
                  <div class="text-sm opacity-70">Estado legal</div>
                  <div>{{ company()!.company!.legal_status }}</div>
                </div>
              }
              @if (company()!.company?.ciiu) {
                <div>
                  <div class="text-sm opacity-70">CIIU</div>
                  <div class="font-mono">{{ company()!.company!.ciiu }}</div>
                </div>
              }
              @if (company()!.company?.company_type) {
                <div>
                  <div class="text-sm opacity-70">Tipo</div>
                  <div>{{ company()!.company!.company_type }}</div>
                </div>
              }
              @if (company()!.company?.incorporation_date) {
                <div>
                  <div class="text-sm opacity-70">Constitución</div>
                  <div>{{ company()!.company!.incorporation_date }}</div>
                </div>
              }
              @if (company()!.company?.address) {
                <div class="sm:col-span-2">
                  <div class="text-sm opacity-70">Dirección</div>
                  <div class="truncate">{{ company()!.company!.address }}</div>
                </div>
              }
              @if (company()!.company?.source_url) {
                <div class="sm:col-span-2">
                  <a class="link link-primary text-sm" [href]="company()!.company!.source_url" target="_blank" rel="noopener">Ver fuente ↗</a>
                </div>
              }
            </div>

            <!-- Score and data quality summary -->
            <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-3">
              @if (company()!.score !== undefined && company()!.score !== null) {
                <div>
                  <div class="text-sm opacity-70">Score</div>
                  <div class="flex items-center gap-2">
                    <span class="badge badge-outline">{{ company()!.score }}</span>
                    @if (company()!.score_source) { <span class="badge badge-ghost">{{ company()!.score_source }}</span> }
                  </div>
                </div>
              }
              @if (company()!.company?.fetched_at) {
                <div>
                  <div class="text-sm opacity-70">Actualizado</div>
                  <div class="text-xs">{{ company()!.company!.fetched_at }}</div>
                </div>
              }
            </div>

            @if (company()!.imputation?.error) {
              <div class="alert alert-warning mt-2 text-sm">
                {{ company()!.imputation!.error }}
              </div>
            }
            @if (company()!.missing_data?.length) {
              <div class="mt-2">
                <div class="text-sm font-medium opacity-80 mb-1">Datos faltantes</div>
                <div class="flex flex-wrap gap-2">
                  @for (m of company()!.missing_data!; track m) { <span class="badge badge-ghost">{{ m }}</span> }
                </div>
              </div>
            }

            @if (company()!.company?.additional) {
              <div class="mt-2">
                <div class="text-sm font-medium opacity-80 mb-1">Atributos adicionales</div>
                <div class="flex flex-wrap gap-2">
                  @if (company()!.company!.additional!.is_state_supplier !== undefined) {
                    <span class="badge badge-outline">Proveedor del Estado: {{ company()!.company!.additional!.is_state_supplier ? 'Sí' : 'No' }}</span>
                  }
                  @if (company()!.company!.additional!.offers_remittances !== undefined) {
                    <span class="badge badge-outline">Remesas: {{ company()!.company!.additional!.offers_remittances ? 'Sí' : 'No' }}</span>
                  }
                  @if (company()!.company!.additional!.sells_on_credit !== undefined) {
                    <span class="badge badge-outline">Vende a crédito: {{ company()!.company!.additional!.sells_on_credit ? 'Sí' : 'No' }}</span>
                  }
                  @if (company()!.company!.additional!.belongs_to_mv !== undefined) {
                    <span class="badge badge-outline">Pertenece a MV: {{ company()!.company!.additional!.belongs_to_mv ? 'Sí' : 'No' }}</span>
                  }
                  @if (company()!.company!.additional!.is_public_interest !== undefined) {
                    <span class="badge badge-outline">Interés público: {{ company()!.company!.additional!.is_public_interest ? 'Sí' : 'No' }}</span>
                  }
                  @if (company()!.company!.additional!.is_bic !== undefined) {
                    <span class="badge badge-outline">BIC: {{ company()!.company!.additional!.is_bic ? 'Sí' : 'No' }}</span>
                  }
                  @if (company()!.company!.additional!.judicial_disposition) {
                    <span class="badge badge-ghost">Disposición judicial: {{ company()!.company!.additional!.judicial_disposition }}</span>
                  }
                </div>
              </div>
            }
            @if (company()!.overview) {
              <div class="prose max-w-none"><p>{{ company()!.overview }}</p></div>
            }
            @if (company()!.metrics) {
              <div>
                <h4 class="font-semibold mb-1">{{ 'ADMIN.COMPANIES.METRICS' | translate }}</h4>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                  @for (k of metricKeys(); track k) {
                    <div class="stat p-2 rounded border">
                      <div class="stat-title text-xs">{{ k }}</div>
                      <div class="stat-value text-sm">{{ company()!.metrics![k] | number:'1.0-2' }}</div>
                    </div>
                  }
                </div>
                <div class="mt-3">
                  <canvas #metricsChart></canvas>
                </div>
              </div>
            }
            @if (company()!.signals?.length) {
              <div>
                <h4 class="font-semibold mb-1">{{ 'ADMIN.COMPANIES.SIGNALS' | translate }}</h4>
                <ul class="list-disc pl-5 space-y-1">
                  @for (s of company()!.signals!; track s.key) {
                    <li><span class="font-mono">{{ s.key }}:</span> {{ s.value }}</li>
                  }
                </ul>
              </div>
            }
            @if (company()!.llm_insights) {
              <div class="space-y-2">
                <h4 class="font-semibold mb-1">{{ 'ADMIN.COMPANIES.LLM_INSIGHTS' | translate }}</h4>
                <ng-container *ngIf="company()!.llm_insights as ins">
                  <!-- Narrative / summary -->
                  @if (ins.narrative) {
                    <div class="prose max-w-none p-3 rounded border bg-base-200/50">
                      <p class="m-0">{{ ins.narrative }}</p>
                    </div>
                  }

                  <!-- Key badges -->
                  <div class="flex flex-wrap gap-2 mt-2">
                    @if (ins.risk_summary) { <span class="badge badge-outline">{{ ins.risk_summary }}</span> }
                    @if (ins.reputation) { <span class="badge badge-outline">{{ ins.reputation }}</span> }
                    @if (ins.credit_recommendation) { <span class="badge badge-outline">{{ ins.credit_recommendation }}</span> }
                  </div>

                  <!-- Lists / arrays rendered nicely -->
          @if (ins.key_factors?.length) {
                    <div>
            <div class="text-sm font-medium opacity-80 mb-1">Factores clave</div>
                      <ul class="list-disc pl-5 space-y-1">
                        @for (k of ins.key_factors; track k) { <li>{{ k }}</li> }
                      </ul>
                    </div>
                  }
                  @if (ins.warnings?.length) {
                    <div>
            <div class="text-sm font-medium text-warning mb-1">Advertencias</div>
                      <ul class="list-disc pl-5 space-y-1">
                        @for (w of ins.warnings; track w) { <li>{{ w }}</li> }
                      </ul>
                    </div>
                  }
                  @if (ins.suggested_actions?.length) {
                    <div>
            <div class="text-sm font-medium opacity-80 mb-1">Acciones sugeridas</div>
                      <ul class="list-disc pl-5 space-y-1">
                        @for (a of ins.suggested_actions; track a) { <li>{{ a }}</li> }
                      </ul>
                    </div>
                  }
                  @if (ins.opportunity_zones?.length) {
                    <div>
            <div class="text-sm font-medium opacity-80 mb-1">Zonas de oportunidad</div>
                      <div class="flex flex-wrap gap-2">
                        @for (o of ins.opportunity_zones; track o) { <span class="badge badge-ghost">{{ o }}</span> }
                      </div>
                    </div>
                  }
                  @if (ins.early_alerts?.length) {
                    <div>
            <div class="text-sm font-medium opacity-80 mb-1">Alertas tempranas</div>
                      <div class="flex flex-wrap gap-2">
                        @for (e of ins.early_alerts; track e) { <span class="badge badge-ghost">{{ e }}</span> }
                      </div>
                    </div>
                  }
                  @if (ins.data_quality_flags?.length) {
                    <div>
            <div class="text-sm font-medium opacity-80 mb-1">Banderas de calidad de datos</div>
                      <ul class="list-disc pl-5 space-y-1">
                        @for (f of ins.data_quality_flags; track f) { <li>{{ f }}</li> }
                      </ul>
                    </div>
                  }

                  <!-- Raw JSON fallback inside collapsible -->
                  <details class="mt-2">
                    <summary class="cursor-pointer text-sm opacity-70">Ver JSON crudo</summary>
                    <pre class="whitespace-pre-wrap text-xs bg-base-200 p-2 rounded mt-2">{{ (ins | json) }}</pre>
                  </details>
                </ng-container>
              </div>
            }
          } @else {
            <div class="opacity-70">{{ 'COMMON.NO_SUMMARY' | translate }}</div>
          }
        </div>
      </div>
    </dialog>
  }
</div>
