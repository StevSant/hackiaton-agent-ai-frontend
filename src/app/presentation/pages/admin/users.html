<div class="p-6 space-y-6 vt-page">
  <h2
    class="text-xl font-semibold sticky top-0 z-20 bg-card/70 backdrop-blur rounded-md p-2"
  >
    {{ "ADMIN.USERS.TITLE" | translate }}
  </h2>

  <div class="search-section">
    <div class="flex items-end justify-between gap-4 flex-wrap">
      <div class="flex items-center gap-3 flex-wrap">
        <div class="form-group">
          <label for="userSearch" class="form-label">
            <mat-icon class="text-sm mr-1">search</mat-icon>
            {{ "ADMIN.USERS.SEARCH_LABEL" | translate }}
          </label>
          <input
            #userSearch
            id="userSearch"
            class="input input-bordered input-sm w-full sm:w-72"
            (keyup.enter)="applySearch(userSearch.value)"
            [placeholder]="'ADMIN.USERS.SEARCH_PLACEHOLDER' | translate"
          />
        </div>
        <button
          class="btn btn-gradient-blue btn-sm mt-6"
          (click)="applySearch(userSearch.value)"
          type="button"
        >
          <mat-icon class="text-sm mr-1">search</mat-icon>
          {{ "ADMIN.USERS.SEARCH_BUTTON" | translate }}
        </button>
      </div>
      <div class="stats-text">
        <mat-icon class="text-sm mr-1">people</mat-icon>
        {{ start() }}–{{ end() }} de {{ total() }}
      </div>
    </div>
  </div>

  <div class="modern-card users-card p-6">
    <div class="mb-4">
      <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
        <mat-icon>person_add</mat-icon>
        {{ "ADMIN.USERS.CREATE_NEW" | translate }}
      </h3>
      <div class="text-sm opacity-70">{{ "ADMIN.USERS.CREATE_DESCRIPTION" | translate }}</div>
    </div>
    <form
      [formGroup]="form"
      (ngSubmit)="create()"
      class="create-form grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end"
    >
      <div class="form-group">
        <label class="form-label" for="username">
          <mat-icon class="text-sm mr-1">person</mat-icon>
          {{ "ADMIN.USERS.USERNAME" | translate }}
        </label>
        <input
          id="username"
          class="input input-bordered w-full"
          formControlName="username"
          [placeholder]="'ADMIN.USERS.USERNAME_PLACEHOLDER' | translate"
        />
      </div>
      <div class="form-group">
        <label class="form-label" for="email">
          <mat-icon class="text-sm mr-1">email</mat-icon>
          {{ "ADMIN.USERS.EMAIL" | translate }}
        </label>
        <input
          id="email"
          class="input input-bordered w-full"
          formControlName="email"
          [placeholder]="'ADMIN.USERS.EMAIL_PLACEHOLDER' | translate"
          type="email"
        />
      </div>
      <div class="form-group md:col-span-2">
        <label class="form-label" for="password">
          <mat-icon class="text-sm mr-1">lock</mat-icon>
          {{ "ADMIN.USERS.PASSWORD" | translate }}
        </label>
        <input
          id="password"
          class="input input-bordered w-full"
          formControlName="password"
          [placeholder]="'ADMIN.USERS.PASSWORD_PLACEHOLDER' | translate"
          type="password"
        />
      </div>
      <div class="form-group">
        <label class="form-label" for="role">
          <mat-icon class="text-sm mr-1">badge</mat-icon>
          {{ "ADMIN.USERS.ROLE" | translate }}
        </label>
        <select
          id="role"
          class="select select-bordered w-full"
          formControlName="role"
        >
          <option [ngValue]="'user'">{{ "COMMON.USER" | translate }}</option>
          <option [ngValue]="'admin'">{{ "COMMON.ADMIN" | translate }}</option>
        </select>
      </div>
      <div class="flex items-end">
        <button
          class="btn btn-gradient-blue w-full"
          [disabled]="form.invalid || creating()"
          type="submit"
        >
          <mat-icon class="text-sm mr-1">add</mat-icon>
          {{ "ADMIN.USERS.CREATE" | translate }}
        </button>
      </div>
    </form>
  </div>

  @if (error()) {
    <div class="modern-card p-4 border-l-4 border-destructive bg-gradient-to-r from-destructive/10 to-destructive/5">
      <div class="flex items-center gap-2">
        <mat-icon class="text-destructive">error</mat-icon>
        <span class="font-medium text-destructive">Error</span>
      </div>
      <div class="mt-2 text-sm">{{ error() }}</div>
    </div>
  }

  <div class="overflow-x-auto modern-card p-6">
    <div class="mb-4">
      <h3 class="text-lg font-semibold flex items-center gap-2">
        <mat-icon>people</mat-icon>
        {{ "ADMIN.USERS.USER_LIST" | translate }}
      </h3>
      <div class="text-sm opacity-70">{{ "ADMIN.USERS.LIST_DESCRIPTION" | translate }}</div>
    </div>
    <table class="users-table text-sm">
      <thead>
        <tr>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('username')">
              <mat-icon class="text-sm mr-1">person</mat-icon>
              {{ "ADMIN.USERS.USERNAME" | translate }}
              <span *ngIf="sortBy() === 'username'" class="ml-1">{{
                sortOrder() === "asc" ? "▲" : "▼"
              }}</span>
            </button>
          </th>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('email')">
              <mat-icon class="text-sm mr-1">email</mat-icon>
              {{ "ADMIN.USERS.EMAIL" | translate }}
              <span *ngIf="sortBy() === 'email'" class="ml-1">{{
                sortOrder() === "asc" ? "▲" : "▼"
              }}</span>
            </button>
          </th>
          <th>
            <mat-icon class="text-sm mr-1">badge</mat-icon>
            {{ "ADMIN.USERS.ROLE" | translate }}
          </th>
          <th>
            <button
              class="btn btn-ghost btn-xs"
              (click)="setSort('created_at')"
            >
              <mat-icon class="text-sm mr-1">schedule</mat-icon>
              {{ "ADMIN.USERS.CREATED" | translate }}
              <span *ngIf="sortBy() === 'created_at'" class="ml-1">{{
                sortOrder() === "asc" ? "▲" : "▼"
              }}</span>
            </button>
          </th>
          <th>
            <mat-icon class="text-sm mr-1">settings</mat-icon>
            {{ "ADMIN.USERS.ACTIONS" | translate }}
          </th>
        </tr>
      </thead>
      <tbody>
        @for (u of users(); track u.user_id) {
          @if (editingId() !== u.user_id) {
            <tr>
              <td>{{ u.username }}</td>
              <td>{{ u.email }}</td>
              <td>
                <span class="role-badge role-{{ u.role }}">
                  <span class="dot"></span>
                  {{ u.role }}
                </span>
              </td>
              <td>{{ u.created_at || "-" }}</td>
              <td class="actions">
                <button class="btn btn-ghost btn-xs mr-2" (click)="startEdit(u)">
                  <mat-icon class="text-sm mr-1">edit</mat-icon>
                  {{ "ADMIN.USERS.EDIT" | translate }}
                </button>
                <button
                  class="btn btn-ghost btn-xs text-error"
                  (click)="confirmDelete(u)"
                >
                  <mat-icon class="text-sm mr-1">delete</mat-icon>
                  {{ "ADMIN.USERS.DELETE" | translate }}
                </button>
              </td>
            </tr>
          } @else {
            <tr>
              <td>
                <input
                  class="input input-bordered w-full"
                  [formControl]="editForm.controls.username"
                />
              </td>
              <td>
                <input
                  class="input input-bordered w-full"
                  [formControl]="editForm.controls.email"
                />
              </td>
              <td>
                <select
                  class="select select-bordered w-full"
                  [formControl]="editForm.controls.role"
                >
                  <option [ngValue]="'user'">
                    {{ "COMMON.USER" | translate }}
                  </option>
                  <option [ngValue]="'admin'">
                    {{ "COMMON.ADMIN" | translate }}
                  </option>
                </select>
              </td>
              <td>
                <input
                  class="input input-bordered w-full"
                  [formControl]="editForm.controls.password"
                  [placeholder]="
                    'ADMIN.USERS.NEW_PASSWORD_OPTIONAL' | translate
                  "
                />
              </td>
              <td class="actions">
                <button
                  class="btn btn-gradient-blue btn-xs mr-2"
                  (click)="saveEdit()"
                >
                  <mat-icon class="text-sm mr-1">save</mat-icon>
                  {{ "ADMIN.USERS.SAVE" | translate }}
                </button>
                <button class="btn btn-ghost btn-xs" (click)="cancelEdit()">
                  <mat-icon class="text-sm mr-1">close</mat-icon>
                  {{ "ADMIN.USERS.CANCEL" | translate }}
                </button>
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <div class="flex items-center justify-end gap-2 pt-2 modern-card p-2">
    <button class="btn btn-sm" (click)="prevPage()" [disabled]="page() <= 1">
      {{ "COMMON.PREVIOUS" | translate }}
    </button>
    <button
      class="btn btn-sm"
      (click)="nextPage()"
      [disabled]="page() * limit() >= total()"
    >
      {{ "COMMON.NEXT" | translate }}
    </button>
  </div>
</div>
