<div class="p-6 space-y-6 vt-page">
  <h2 class="text-xl font-semibold">{{ 'ADMIN.USERS.TITLE' | translate }}</h2>

  <div class="flex items-end justify-between gap-3">
    <div class="flex items-center gap-2">
      <label for="userSearch" class="text-xs">{{ 'ADMIN.USERS.SEARCH_LABEL' | translate }}</label>
      <input #userSearch id="userSearch" class="input input-bordered input-sm"
        (keyup.enter)="applySearch(userSearch.value)" [placeholder]="'ADMIN.USERS.SEARCH_PLACEHOLDER' | translate" />
      <button class="btn btn-sm" (click)="applySearch(userSearch.value)" type="button">{{ 'ADMIN.USERS.SEARCH_BUTTON' |
        translate }}</button>
    </div>
    <div class="text-sm opacity-70">{{ start() }}–{{ end() }} de {{ total() }}</div>
  </div>

  <div class="glass-card users-card p-4">
  <form [formGroup]="form" (ngSubmit)="create()" class="grid grid-cols-1 md:grid-cols-5 gap-3 items-end">
    <div>
      <label class="text-xs" for="username">{{ 'ADMIN.USERS.USERNAME' | translate }}</label>
      <input id="username" class="input input-bordered w-full" formControlName="username"
        [placeholder]="'ADMIN.USERS.USERNAME_PLACEHOLDER' | translate" />
    </div>
    <div>
      <label class="text-xs" for="email">{{ 'ADMIN.USERS.EMAIL' | translate }}</label>
      <input id="email" class="input input-bordered w-full" formControlName="email"
        [placeholder]="'ADMIN.USERS.EMAIL_PLACEHOLDER' | translate" type="email" />
    </div>
    <div class="md:col-span-2">
      <label class="text-xs" for="password">{{ 'ADMIN.USERS.PASSWORD' | translate }}</label>
      <input id="password" class="input input-bordered w-full" formControlName="password"
        [placeholder]="'ADMIN.USERS.PASSWORD_PLACEHOLDER' | translate" type="password" />
    </div>
    <div>
      <label class="text-xs" for="role">{{ 'ADMIN.USERS.ROLE' | translate }}</label>
      <select id="role" class="select select-bordered w-full" formControlName="role">
        <option [ngValue]="'user'">{{ 'COMMON.USER' | translate }}</option>
        <option [ngValue]="'admin'">{{ 'COMMON.ADMIN' | translate }}</option>
      </select>
    </div>
    <div>
  <button class="btn btn-gradient-blue" [disabled]="form.invalid || creating()" type="submit">{{ 'ADMIN.USERS.CREATE' |
        translate }}</button>
    </div>
  </form>
  </div>

  @if (error()) {
  <div class="alert alert-error">{{ error() }}</div>
  }

  <div class="overflow-x-auto glass-card p-2">
    <table class="users-table text-sm">
      <thead>
        <tr>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('username')">{{ 'ADMIN.USERS.USERNAME' | translate }}
              <span *ngIf="sortBy()==='username'">{{ sortOrder()==='asc' ? '▲' : '▼' }}</span>
            </button>
          </th>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('email')">{{ 'ADMIN.USERS.EMAIL' | translate }}
              <span *ngIf="sortBy()==='email'">{{ sortOrder()==='asc' ? '▲' : '▼' }}</span>
            </button>
          </th>
          <th>{{ 'ADMIN.USERS.ROLE' | translate }}</th>
          <th>
            <button class="btn btn-ghost btn-xs" (click)="setSort('created_at')">{{ 'ADMIN.USERS.CREATED' | translate }}
              <span *ngIf="sortBy()==='created_at'">{{ sortOrder()==='asc' ? '▲' : '▼' }}</span>
            </button>
          </th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        @for (u of users(); track u.user_id) {
        @if (editingId() !== u.user_id) {
        <tr>
          <td>{{ u.username }}</td>
          <td>{{ u.email }}</td>
          <td>
            <span class="role-badge role-{{u.role}}">
              <span class="dot"></span>
              {{ u.role }}
            </span>
          </td>
          <td>{{ u.created_at || '-' }}</td>
          <td class="actions">
            <button class="btn btn-ghost btn-xs" (click)="startEdit(u)">{{ 'ADMIN.USERS.EDIT' | translate }}</button>
            <button class="btn btn-ghost btn-xs text-error" (click)="confirmDelete(u)">{{ 'ADMIN.USERS.DELETE' |
              translate }}</button>
          </td>
        </tr>
        } @else {
    <tr>
      <td><input class="input input-bordered w-full" [formControl]="editForm.controls.username" /></td>
      <td><input class="input input-bordered w-full" [formControl]="editForm.controls.email" /></td>
      <td>
        <select class="select select-bordered w-full" [formControl]="editForm.controls.role">
                  <option [ngValue]="'user'">{{ 'COMMON.USER' | translate }}</option>
                  <option [ngValue]="'admin'">{{ 'COMMON.ADMIN' | translate }}</option>
                </select>
          </td>
      <td><input class="input input-bordered w-full" [formControl]="editForm.controls.password"
              [placeholder]="'ADMIN.USERS.NEW_PASSWORD_OPTIONAL' | translate" /></td>
      <td class="actions">
            <button class="btn btn-gradient-blue btn-xs" (click)="saveEdit()">{{ 'ADMIN.USERS.SAVE' | translate }}</button>
            <button class="btn btn-ghost btn-xs" (click)="cancelEdit()">{{ 'ADMIN.USERS.CANCEL' | translate }}</button>
          </td>
        </tr>
        }
        }
      </tbody>
    </table>
  </div>

  <div class="flex items-center justify-end gap-2 pt-2 glass-card p-2">
    <button class="btn btn-sm" (click)="prevPage()" [disabled]="page()<=1">{{ 'COMMON.PREVIOUS' | translate }}</button>
    <button class="btn btn-sm" (click)="nextPage()" [disabled]="page()*limit()>=total()">{{ 'COMMON.NEXT' | translate
      }}</button>
  </div>
</div>