<div class="flex min-h-screen h-full relative bg-base-200">
  <!-- Sidebar placeholder - puedes agregar tu sidebar aquí -->

  <div class="chat-container h-screen w-full p-4 md:p-8 flex flex-col gap-4 max-h-screen">
    <!-- Contenedor de chat -->
    <div class="flex-1 flex flex-col gap-4 min-h-0">
      <!-- Contenedor de mensajes con scroll -->
      <div #messagesContainer
        class="messages-container flex-1 overflow-y-auto p-4 space-y-4 bg-base-100 rounded-xl shadow-sm relative"
        (scroll)="onMessagesScroll()" style="max-height: calc(100vh - 250px);">
        <!-- Estado vacío mejorado -->
        @if (messages.length === 0 && !isSending) {
        <div class="flex flex-col items-center justify-center h-full min-h-[300px] text-center">
          <div class="text-6xl mb-4">💬</div>
          <h4 class="text-xl font-semibold mb-2">{{ 'CHAT.EMPTY.TITLE' | translate }}</h4>
          <p class="text-base-content/70 max-w-md">{{ 'CHAT.EMPTY.SUBTITLE' | translate }}</p>
        </div>
        }

        <!-- Mensajes -->
        @for (message of messages; track trackByMessageId($index, message))
        {

        <!-- Mensaje del Usuario -->
        @if (isUserMessage(message)) {
        <div class="chat chat-start msg-user">
          <div class="chat-header mb-1">
            <span class="text-xs opacity-60">{{
              getEventLabel(message.event)
              }}</span>
            <time class="text-xs opacity-60 ml-2">{{
              formatTimestamp(message.timestamp)
              }}</time>
          </div>
          <div class="chat-bubble chat-bubble-primary max-w-xs md:max-w-md lg:max-w-lg">
            {{ message.displayedContent }}
          </div>
        </div>
        }

        <!-- Mensaje del Bot -->
        @if (isBotMessage(message)) {
        <div class="chat chat-end msg-bot">
          <div class="chat-header mb-1">
            <span class="text-xs opacity-60">{{
              getEventLabel(message.event)
              }}</span>
            <time class="text-xs opacity-60 ml-2">{{
              formatTimestamp(message.timestamp)
              }}</time>
            @if (message.isStreaming) {
            <span class="loading loading-dots loading-xs ml-2"></span>
            }
          </div>
          <div class="chat-bubble bg-base-200 text-base-content max-w-xs md:max-w-md lg:max-w-2xl">
            <div class="prose prose-sm max-w-none">
              <!-- {{ message.displayedContent }} -->
              <markdown [data]="message.displayedContent"></markdown>
            </div>
            <!-- Reasoning steps -->
            @if (message.extra_data?.reasoning_steps?.length) {
            <div class="mt-3 border-t pt-2">
              <div class="text-xs font-semibold mb-1">Razonamiento</div>
              <ul class="list-disc ml-5 text-xs space-y-1">
                @for (step of message.extra_data?.reasoning_steps; track step.title) {
                <li>
                  <div class="font-medium">{{ step.title }}</div>
                  <div class="opacity-80">{{ step.reasoning }}</div>
                  @if (step.result) { <div class="opacity-70">→ {{ step.result }}</div> }
                </li>
                }
              </ul>
            </div>
            }
            <!-- References -->
            @if (message.extra_data?.references?.length) {
            <div class="mt-3 border-t pt-2">
              <div class="text-xs font-semibold mb-1">Referencias</div>
              <ul class="list-disc ml-5 text-xs space-y-1">
                @for (block of message.extra_data?.references; track block.query) {
                <li>
                  <div class="font-medium">Consulta: {{ block.query }}</div>
                  <ul class="list-disc ml-5">
                    @for (ref of block.references; track ref.name) {
                    <li>
                      <div class="opacity-90">{{ ref.name }}</div>
                      <div class="opacity-70">{{ ref.content }}</div>
                    </li>
                    }
                  </ul>
                </li>
                }
              </ul>
            </div>
            }
            <!-- Media: images/videos/audio -->
            @if (message.images?.length) {
            <div class="mt-2 grid grid-cols-2 gap-2">
              @for (img of message.images; track img.url) {
              <img [src]="img.url" alt="media" class="rounded-md max-h-48 object-cover" />
              }
            </div>
            }
            @if (message.videos?.length) {
            <div class="mt-2 space-y-2">
              @for (v of message.videos; track v.url) {
              <video class="rounded-md w-full" controls [src]="v.url">
                <track kind="captions" />
              </video>
              }
            </div>
            }
            <!-- TTS controls for Bot Messages -->
            @if (isBotMessage(message) && message.content.trim()) {
            <div class="mt-2 flex flex-wrap items-center gap-2">
              <!-- Play / Pause / Resume / Stop -->
              @if (!isPlayingFor(message.id)) {
              <button class="btn btn-xs btn-ghost" (click)="playAgentResponse(message.content, message.id)" title="Reproducir">
                <mat-icon fontIcon="play_arrow"></mat-icon>
              </button>
              }
              @if (isPlayingFor(message.id) && !isPausedFor(message.id)) {
              <button class="btn btn-xs btn-ghost" (click)="ttsPause()" title="Pausar">
                <mat-icon fontIcon="pause"></mat-icon>
              </button>
              }
              @if (isPausedFor(message.id)) {
              <button class="btn btn-xs btn-ghost" (click)="ttsResume()" title="Reanudar">
                <mat-icon fontIcon="play_arrow"></mat-icon>
              </button>
              }
              @if (isPlayingFor(message.id) || isPausedFor(message.id)) {
              <button class="btn btn-xs btn-ghost" (click)="ttsStop()" title="Detener">
                <mat-icon fontIcon="stop"></mat-icon>
              </button>
              }

              <!-- Volume -->
              <div class="flex items-center gap-2 ml-2">
                <mat-icon fontIcon="volume_up" class="opacity-70"></mat-icon>
                <input type="range" min="0" max="1" step="0.05"
                  [value]="tts.volume"
                  (input)="onVolumeInput($event)"
                  (change)="onVolumeCommit($event)"
                  class="range range-xs w-32" />
                <span class="text-xs opacity-70 w-8 text-right">{{ (tts.volume * 100) | number:'1.0-0' }}%</span>
              </div>
            </div>
            }
            @if (message.isStreaming && message.displayedContent.length < message.content.length) { <span
              class="inline-block w-1 h-4 bg-current animate-pulse ml-1 opacity-70"></span>
              }
          </div>
        </div>
        }

        <!-- Mensaje del Sistema -->
        @if (isSystemMessage(message)) {
        <div class="flex justify-center my-2 msg-system">
          <div class="flex items-center gap-2 px-4 py-2 bg-info/10 text-info rounded-full text-sm">
            <span class="opacity-70">{{
              formatTimestamp(message.timestamp)
              }}</span>
            <span>{{ message.displayedContent }}</span>
          </div>
        </div>
        } }

        <!-- Indicador de carga principal (al inicio del chat) -->
        @if (isSending && messages.length <= 1) { <div class="flex justify-center items-center py-8">
          <div class="flex flex-col items-center gap-4">
            <div class="loading loading-dots loading-lg text-primary"></div>
            <p class="text-base-content/70">{{ 'CHAT.SENDING' | translate }}</p>
          </div>
      </div>
      }

      <!-- Loader sutil cuando se ejecutan herramientas -->
      @if (toolRunning) {
      <div class="flex justify-center items-center py-2">
        <div class="loading loading-dots loading-sm text-info" [attr.aria-label]="'CHAT.RUNNING_TOOLS' | translate">
        </div>
        <span class="text-xs ml-2 text-info/80">{{ 'CHAT.RUNNING_TOOLS' | translate }}</span>
      </div>
      }

      <!-- Botón flotante para bajar al final -->
      @if (showScrollToBottom) {
      <button type="button" class="btn btn-primary btn-circle scroll-to-bottom-btn shadow-lg" (click)="scrollToBottom()"
        title="Bajar al final">
        <mat-icon fontIcon="arrow_downward"></mat-icon>
      </button>
      }
    </div>

    <!-- Composer estilo ChatGPT -->
  <div class="composer-surface bg-base-100 rounded-xl shadow-sm p-3 md:p-4">
      <form [formGroup]="msgForm" (submit)="sendMessage()" class="w-full">
        <div class="flex flex-col gap-3">
          <div class="flex items-end gap-2 md:gap-3">
            <!-- Botón adjuntar -->
            <label class="btn btn-ghost btn-square btn-sm md:btn-md" title="Adjuntar archivos">
              <input type="file" multiple class="hidden" (change)="onFilesSelected($event)" />
              <mat-icon fontIcon="attach_file"></mat-icon>
            </label>

            <!-- Área de texto con auto-resize y pills -->
            <div class="flex-1">
              <div
                class="rounded-xl border border-base-300 bg-base-100 focus-within:border-primary transition px-3 py-2 md:px-4 md:py-3">
                <textarea class="w-full bg-transparent outline-none resize-none leading-6 md:leading-7"
                  [placeholder]="('CHAT.PLACEHOLDER' | translate)" rows="1" spellcheck="true" formControlName="message"
                  (input)="handleComposerInput($event)" (keydown)="handleKeyDown($event)"></textarea>
              </div>
              @if (msgForm.get('message')?.invalid && msgForm.get('message')?.touched) {
              <div class="text-error text-xs md:text-sm mt-1">{{ 'CHAT.ERROR_REQUIRED' | translate }}</div>
              }
            </div>

            <!-- Enviar / Cancelar -->
            <div class="flex items-center gap-2">
              <button type="submit" class="btn btn-primary btn-square btn-sm md:btn-md"
                [disabled]="isSending || !msgForm.valid" [class.loading]="isSending" title="Enviar">
                @if (!isSending) { <mat-icon fontIcon="send"></mat-icon> }
              </button>
              @if (isSending) {
              <button type="button" class="btn btn-outline btn-square btn-sm md:btn-md" (click)="cancelSending()"
                title="Cancelar">
                <mat-icon fontIcon="close"></mat-icon>
              </button>
              }
            </div>
          </div>

          <!-- Línea de información secundaria -->
          <div class="flex flex-wrap items-center justify-between gap-2 text-xs opacity-70">
            <div class="hidden sm:block">{{ 'CHAT.HINT' | translate }}</div>
            <div class="flex items-center gap-2">
              @if (filesToUpload.length) {
              <div class="badge badge-info">{{ 'CHAT.FILES_COUNT' | translate:{ count: filesToUpload.length } }}</div>
              }
              <span>{{ msgForm.get('message')?.value?.length || 0 }}/1000</span>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>
</div>